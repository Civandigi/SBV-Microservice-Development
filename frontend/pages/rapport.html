<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapport-Management - SBV Professional</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="../assets/css/responsive-improvements.css">
    <link rel="stylesheet" href="../assets/css/responsive-framework.css">
    <link rel="stylesheet" href="../assets/css/sidebar-preload.css">
    <!-- Master Typography - MUSS als LETZTE CSS Datei kommen -->
    <link rel="stylesheet" href="../assets/css/master-typography.css">
    <script src="../assets/js/tailwind-config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --color-primary: #A4D2F4;
            --color-secondary: #6BAF38;
            --color-danger: #ef4444;
            --color-warning: #f59e0b;
            --color-success: #10b981;
            --color-text-primary: #111827;
            --color-text-secondary: #6B7280;
            --color-bg-primary: #ffffff;
            --color-bg-secondary: #f3f4f6;
            --color-card-background: #FFFFFF;
            --color-border: #E5E7EB;
            --color-red: #DC2626;
            --color-black: #000000;
            --color-light-blue: #A4D2F4;
            --color-green: #6BAF38;
            --color-background: #F8FAFC;
        }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .status-ausstehend { background-color: #fef3c7; color: #92400e; }
        .status-in-bearbeitung { background-color: #dbeafe; color: #1e40af; }
        .status-zur-pruefung { background-color: #fef3c7; color: #92400e; }
        .status-genehmigt { background-color: #d1fae5; color: #065f46; }
        .status-abgelehnt { background-color: #fee2e2; color: #991b1b; }
        
        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: var(--color-secondary);
            transition: width 0.5s ease;
        }
        
        
        .tab-button {
            padding: 0.5rem 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        .tab-button.active {
            border-bottom-color: var(--color-primary);
            color: #1e40af;
        }
        
        .budget-variance {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        .variance-positive { color: var(--color-success); }
        .variance-negative { color: var(--color-danger); }
        .variance-warning { color: var(--color-warning); }
        
        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 1rem;
            border-radius: 9999px;
            transition: all 0.3s;
            text-decoration: none;
        }
        .nav-link-active {
            background-color: rgba(164, 210, 244, 0.3);
            color: var(--color-black);
            font-weight: 600;
        }
        .nav-link-inactive {
            color: var(--color-text-secondary);
            font-weight: 500;
        }
        .nav-link-inactive:hover {
            background-color: #f3f4f6;
        }
        
        /* Tooltip Styles für Info-Icons */
        .group:hover .group-hover\:block {
            display: block !important;
        }
        
        /* Kleinere Buttons in Admin-Bereich */
        .admin-action-btn {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }
        
        /* Dropdown-Menü Styles */
        .dropdown-menu {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 9999 !important;
        }
        
        /* Aktions-Dropdown speziell */
        [id^="action-menu-"] {
            z-index: 9999 !important;
        }
        
        /* Modal Scroll-Verhalten */
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-[var(--color-background)]">
    <!-- Universal Dialog System -->
    <div id="dialogOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center">
        <div id="dialogBox" class="bg-white rounded-lg shadow-2xl max-w-md w-full mx-4 transform transition-all">
            <div id="dialogHeader" class="px-6 py-4 border-b border-gray-200">
                <h3 id="dialogTitle" class="text-lg font-semibold text-gray-900"></h3>
            </div>
            <div id="dialogBody" class="px-6 py-4">
                <p id="dialogMessage" class="text-gray-700"></p>
                <input type="text" id="dialogInput" class="hidden mt-3 w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            <div id="dialogFooter" class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                <!-- Buttons werden dynamisch eingefügt -->
            </div>
        </div>
    </div>
    
    <!-- Mobile Menu Button (Schwebend) -->
    <button id="mobile-menu-toggle" class="mobile-menu-toggle">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
    </button>
    
    <div class="app-wrapper">
        <div class="app-container">
            <!-- Mobile Overlay -->
            <div id="mobile-overlay" class="sidebar-overlay"></div>
            
            <!-- SBV Navigation Sidebar -->
            <aside id="sidebar" class="app-sidebar bg-[var(--color-card-background)] shadow-lg flex flex-col p-6">
            <!-- Sidebar content will be loaded by sidebar-component.js -->
            </aside>

            <!-- Main Content Area -->
            <main class="app-content">
                <!-- Header -->
                <div class="content-wrapper">
                <h1 class="text-2xl sm:text-3xl font-bold text-[var(--color-text-primary)] mb-6 sm:mb-8">Rapport-Management</h1>
            </div>

        <!-- Action Bar -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-6 px-8 flex flex-wrap justify-between items-center gap-4">
            <div class="flex gap-4 flex-wrap">
                <select id="jahrFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Alle Jahre</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                </select>
                <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Alle Status</option>
                    <option value="ausstehend">Ausstehend</option>
                    <option value="in-bearbeitung">In Bearbeitung</option>
                    <option value="zur-pruefung">Zur Prüfung</option>
                    <option value="genehmigt">Genehmigt</option>
                    <option value="abgelehnt">Abgelehnt</option>
                </select>
                <select id="teilprojektFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Alle Teilprojekte</option>
                    <option value="leitmedien">Leitmedien</option>
                    <option value="digitale-medien">Digitale Medien</option>
                    <option value="messen">Messen & Ausstellungen</option>
                    <option value="social-media">Social Media</option>
                </select>
            </div>
            <button onclick="showCreateModal()" class="bg-[var(--color-secondary)] text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                + Neuer Rapport
            </button>
        </div>

        <!-- KPI Overview Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 px-8">
            <div class="border border-gray-200 rounded-lg p-4 bg-white">
                <div class="text-gray-600 text-sm mb-1 font-medium">Gesamtbudget</div>
                <div class="text-2xl sm:text-3xl font-bold text-gray-900" id="totalBudget">Lädt...</div>
                <div class="text-xs text-gray-500 mt-1">Genehmigt für 2024</div>
            </div>
            <div class="border border-gray-200 rounded-lg p-4 bg-white">
                <div class="text-gray-600 text-sm mb-1 font-medium">Ausgegeben</div>
                <div class="text-2xl sm:text-3xl font-bold text-blue-600" id="spentBudget">Lädt...</div>
                <div class="text-xs text-gray-500 mt-1">% verbraucht</div>
                <div class="progress-bar mt-2">
                    <div class="progress-fill" id="budgetProgress" style="width: 0%"></div>
                </div>
            </div>
            <div class="border border-gray-200 rounded-lg p-4 bg-white">
                <div class="text-gray-600 text-sm mb-1 font-medium">Budget-Auslastung</div>
                <div class="text-2xl sm:text-3xl font-bold text-orange-600" id="budgetUtilization">Lädt...</div>
                <div class="text-xs text-gray-500 mt-1">Prozent genutzt</div>
            </div>
            <div class="border border-gray-200 rounded-lg p-4 bg-white">
                <div class="text-gray-600 text-sm mb-1 font-medium">Aktive Rapporte</div>
                <div class="text-2xl sm:text-3xl font-bold text-green-600" id="activeReports">Lädt...</div>
                <div class="text-xs text-gray-500 mt-1">In Bearbeitung</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow-sm mx-8">
            <div class="border-b border-gray-200">
                <nav class="flex">
                    <button class="tab-button active" onclick="switchTab('rapporte', this)">
                        Rapporte
                    </button>
                    <button class="tab-button" onclick="switchTab('teilprojekte', this)">
                        Teilprojekte
                    </button>
                    <button class="tab-button" onclick="switchTab('kpis', this)">
                        KPI-Übersicht
                    </button>
                    <!-- Report-Verwaltung nur für Admin/Super Admin -->
                    <button class="tab-button" onclick="switchTab('verwaltung', this)" id="verwaltung-button" style="display: none;">
                        Report-Verwaltung
                    </button>
                    <!-- Rapport-Anforderungen Tab -->
                    <button class="tab-button" onclick="switchTab('anforderungen', this)" id="anforderungen-button">
                        <span id="anforderungen-badge" class="hidden bg-red-500 text-white text-xs px-2 py-1 rounded-full ml-2">0</span>
                        Anforderungen
                    </button>
                </nav>
            </div>

            <!-- Tab Content: Rapporte -->
            <div id="rapporte-tab" class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold">Meine Rapporte</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-4">Rapport-Nr.</th>
                                <th class="text-left py-3 px-4">Teilprojekt</th>
                                <th class="text-left py-3 px-4">Periode</th>
                                <th class="text-left py-3 px-4">Status</th>
                                <th class="text-left py-3 px-4">Fortschritt</th>
                                <th class="text-left py-3 px-4">Budget-Varianz</th>
                                <th class="text-left py-3 px-4">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="rapportTableBody">
                            <!-- Dynamisch gefüllt -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab Content: Teilprojekte -->
            <div id="teilprojekte-tab" class="p-6 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="teilprojekteContainer">
                    <!-- Teilprojekt Cards werden hier dynamisch eingefügt -->
                </div>
            </div>

            <!-- Tab Content: KPIs -->
            <div id="kpis-tab" class="p-6 hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="kpisContainer">
                    <!-- KPI Charts und Metriken -->
                </div>
            </div>

            <!-- Tab Content: Report-Verwaltung -->
            <div id="verwaltung-tab" class="p-6 hidden">
                <div class="space-y-6">
                    <!-- Übersicht und Aktionen -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-xl font-semibold text-gray-900">Report-Verwaltung</h2>
                                <p class="text-gray-600">Verwalten Sie eingereichte Reports und erstellen Sie Gesamtberichte</p>
                            </div>
                            <div class="flex gap-2 items-center">
                                <!-- Gesamtreport Button mit Info -->
                                <div class="relative group">
                                    <button onclick="generateFinalReport()" class="bg-green-600 text-white px-3 py-1.5 rounded text-sm hover:bg-green-700 transition-colors flex items-center">
                                        <i class="fas fa-file-export mr-1.5 text-xs"></i>
                                        <span>Gesamtreport</span>
                                    </button>
                                    <button class="ml-1 text-gray-400 hover:text-gray-600" onclick="showInfoModal('gesamtreport')">
                                        <i class="fas fa-info-circle text-sm"></i>
                                    </button>
                                    <!-- Tooltip -->
                                    <div class="absolute hidden group-hover:block z-10 w-64 p-2 mt-1 text-xs bg-gray-800 text-white rounded shadow-lg">
                                        Fasst alle bestätigten Rapporte zu einem Jahresbericht zusammen
                                    </div>
                                </div>
                                
                                <!-- Google Docs Export Button mit Info -->
                                <div class="relative group">
                                    <button onclick="exportToGoogleDocs()" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-700 transition-colors flex items-center">
                                        <i class="fab fa-google mr-1.5 text-xs"></i>
                                        <span>Google Docs</span>
                                    </button>
                                    <button class="ml-1 text-gray-400 hover:text-gray-600" onclick="showInfoModal('googledocs')">
                                        <i class="fas fa-info-circle text-sm"></i>
                                    </button>
                                    <!-- Tooltip -->
                                    <div class="absolute hidden group-hover:block z-10 w-64 p-2 mt-1 text-xs bg-gray-800 text-white rounded shadow-lg right-0">
                                        Erstellt ein bearbeitbares Dokument für Word oder Google Docs
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Status-Übersicht -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <p class="text-2xl font-bold text-blue-600" id="totalReports">-</p>
                                <p class="text-blue-600">Reports gesamt</p>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <p class="text-2xl font-bold text-yellow-600" id="pendingReports">-</p>
                                <p class="text-yellow-600">Ausstehend</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <p class="text-2xl font-bold text-green-600" id="approvedReports">-</p>
                                <p class="text-green-600">Bestätigt</p>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <p class="text-2xl font-bold text-purple-600" id="completedReports">-</p>
                                <p class="text-purple-600">Abgeschlossen</p>
                            </div>
                        </div>

                        <!-- Filter und Suche -->
                        <div class="mb-6 flex gap-4">
                            <input type="text" id="reportSearch" placeholder="Reports suchen..." 
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <select id="statusFilterReports" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Alle Status</option>
                                <option value="ausstehend">Ausstehend</option>
                                <option value="in_bearbeitung">In Bearbeitung</option>
                                <option value="bestätigt">Bestätigt</option>
                                <option value="abgeschlossen">Abgeschlossen</option>
                            </select>
                            <select id="yearFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="2024" selected>2024</option>
                            </select>
                            </select>
                        </div>
                        
                        <!-- Reports-Tabelle -->
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                            <input type="checkbox" id="selectAllReports" onchange="toggleSelectAllReports()" class="rounded border-gray-300">
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Report</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ersteller</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Datum/Zeit</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Budget</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fortschritt</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody id="reportTableBody" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                                            <div class="flex items-center justify-center">
                                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                Reports werden geladen...
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Bulk-Aktionen für Reports -->
                        <div id="bulkReportActions" class="mt-4 p-4 bg-gray-50 rounded-lg hidden">
                            <div class="flex items-center gap-4">
                                <span class="font-medium"><span id="selectedReportCount">0</span> Reports ausgewählt</span>
                                <button onclick="bulkApproveReports()" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                    Alle bestätigen
                                </button>
                                <button onclick="bulkRejectReports()" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                    Alle ablehnen
                                </button>
                                <button onclick="exportSelectedReports()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                    Auswahl exportieren
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Gesamtreport Vorschau -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-900">Gesamtreport Vorschau</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <p class="font-medium">Jahresbericht 2025 - Kommunikationsförderung Landwirtschaft</p>
                                    <p class="text-sm text-gray-600">Basierend auf bestätigten Teilprojekt-Reports</p>
                                </div>
                                <button onclick="previewFinalReport()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-eye mr-2"></i>Vollständige Vorschau
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="bg-white p-3 rounded">
                                    <p class="text-sm font-medium text-gray-700">Teilprojekte</p>
                                    <p class="text-xl font-bold text-blue-600" id="totalTeilprojekte">6</p>
                                </div>
                                <div class="bg-white p-3 rounded">
                                    <p class="text-sm font-medium text-gray-700">Gesamtbudget</p>
                                    <p class="text-xl font-bold text-green-600" id="totalBudget">CHF 4.41M</p>
                                </div>
                                <div class="bg-white p-3 rounded">
                                    <p class="text-sm font-medium text-gray-700">Bearbeitungsstand</p>
                                    <p class="text-xl font-bold text-purple-600" id="overallProgress">85%</p>
                                </div>
                            </div>

                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span>TP1 - Leitmedien</span>
                                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Bestätigt</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>TP2 - Digitale Medien</span>
                                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Bestätigt</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>TP3 - Messen & Ausstellungen</span>
                                    <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">Ausstehend</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>TP4 - Social Media</span>
                                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Bestätigt</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>TP5 - Newsletter</span>
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">In Bearbeitung</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>TP6 - Werbematerialien</span>
                                    <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">Ausstehend</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Anforderungen -->
            <div id="anforderungen-tab" class="p-6 hidden">
                <!-- User View: Angeforderte Rapporte -->
                <div id="user-anforderungen" class="space-y-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">Angeforderte Rapporte</h2>
                        <div id="anforderungen-list" class="space-y-4">
                            <!-- Wird dynamisch geladen -->
                        </div>
                    </div>
                </div>
                
                <!-- Admin View: Anforderungen verwalten -->
                <div id="admin-anforderungen" class="space-y-6 hidden">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-semibold text-gray-900">Rapport-Anforderungen verwalten</h2>
                            <button onclick="showRequestModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                <i class="fas fa-plus mr-2"></i>Neuen Rapport anfordern
                            </button>
                        </div>
                        
                        <!-- Anforderungen Übersicht -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-red-50 p-3 rounded-lg">
                                <p class="text-sm text-gray-600">Überfällig</p>
                                <p class="text-2xl font-bold text-red-600" id="overdue-count">0</p>
                            </div>
                            <div class="bg-yellow-50 p-3 rounded-lg">
                                <p class="text-sm text-gray-600">Dringend (< 3 Tage)</p>
                                <p class="text-2xl font-bold text-yellow-600" id="urgent-count">0</p>
                            </div>
                            <div class="bg-blue-50 p-3 rounded-lg">
                                <p class="text-sm text-gray-600">Offen</p>
                                <p class="text-2xl font-bold text-blue-600" id="pending-count">0</p>
                            </div>
                            <div class="bg-green-50 p-3 rounded-lg">
                                <p class="text-sm text-gray-600">Erfüllt</p>
                                <p class="text-2xl font-bold text-green-600" id="fulfilled-count">0</p>
                            </div>
                        </div>
                        
                        <!-- Anforderungen Tabelle -->
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b">
                                        <th class="text-left py-3 px-4">User</th>
                                        <th class="text-left py-3 px-4">Teilprojekt</th>
                                        <th class="text-left py-3 px-4">Deadline</th>
                                        <th class="text-left py-3 px-4">Status</th>
                                        <th class="text-left py-3 px-4">Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-anforderungen-table">
                                    <!-- Wird dynamisch geladen -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
                </div>
            </main>
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div id="rapportModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-6xl shadow-lg rounded-lg bg-white m-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900" id="modalTitle">Neuer Rapport</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="rapportForm" onsubmit="handleSubmit(event)">
                <!-- Grundinformationen -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-4">Grundinformationen</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Teilprojekt</label>
                            <select name="teilprojekt" id="teilprojektSelect" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Bitte wählen</option>
                                <option value="tp1-leitmedien">TP1 - Leitmedien</option>
                                <option value="tp2-digitale-medien">TP2 - Digitale Medien</option>
                                <option value="tp3-messen">TP3 - Messen & Ausstellungen</option>
                                <option value="tp4-events">TP4 - Events & Aktionen</option>
                                <option value="tp5-schulprojekte">TP5 - Schulprojekte</option>
                                <option value="tp6-partnerprojekte">TP6 - Partnerprojekte (inkl. KEP)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Berichtsjahr</label>
                            <select name="jahr" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="2024" selected>2024</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Berichtsperiode</label>
                            <select name="periode" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="">Bitte wählen</option>
                                <option value="Q1-2024">Q1 2024</option>
                                <option value="Q2-2024">Q2 2024</option>
                                <option value="Q3-2024">Q3 2024</option>
                                <option value="Q4-2024">Q4 2024</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Teilprojekt Details -->
                <div id="teilprojektDetailsContainer" class="mb-6 hidden">
                    <h4 class="text-lg font-semibold mb-4">Teilprojekt-Details</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Teilprojekt Name</label>
                            <input type="text" id="teilprojektNameField" name="teilprojektName" 
                                   class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg" readonly>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Beschreibung</label>
                            <textarea id="teilprojektBeschreibungField" name="teilprojektBeschreibung" rows="3" 
                                     class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ziele</label>
                            <textarea id="teilprojektZieleField" name="teilprojektZiele" rows="4" 
                                     class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">K-Zielbezug</label>
                            <textarea id="teilprojektKZielbezugField" name="teilprojektKZielbezug" rows="3" 
                                     class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg" 
                                     placeholder="Kommunikationsziele und deren Bezug zum Teilprojekt"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Gesamtbudget (CHF)</label>
                                <input type="text" id="teilprojektBudgetField" name="teilprojektGesamtbudget" 
                                       class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Anzahl Massnahmen</label>
                                <input type="text" id="teilprojektMassnahmenCountField" name="teilprojektMassnahmenCount" 
                                       class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Budget & Kosten Übersicht -->
                <div class="mb-6 bg-blue-50 p-4 rounded-lg">
                    <h4 class="text-lg font-semibold mb-4">Budget & Kosten Übersicht</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Budget Brutto (CHF)</label>
                            <input type="number" name="budgetBrutto" step="0.01" 
                                   class="w-full px-3 py-2 bg-yellow-50 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500"
                                   onchange="calculateVariance()" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">IST Brutto (CHF)</label>
                            <input type="number" name="istBrutto" step="0.01" 
                                   class="w-full px-3 py-2 bg-yellow-50 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500"
                                   onchange="calculateVariance()" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Aufwandsminderung (CHF)</label>
                            <input type="number" name="aufwandsminderung" step="0.01" 
                                   class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg"
                                   readonly placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kosten Netto (CHF)</label>
                            <div id="kostenNetto" class="px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg font-semibold">
                                CHF 0
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center">
                        <span class="text-sm font-medium text-gray-700 mr-2">Budget-Varianz:</span>
                        <span id="budgetVarianz" class="text-lg font-bold text-gray-600">0%</span>
                    </div>
                </div>

                <!-- Massnahmen -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-4">Massnahmen</h4>
                    <div id="massnahmenContainer">
                        <!-- Dynamisch gefüllt basierend auf Teilprojekt -->
                    </div>
                </div>

                <!-- K-Ziele / KPIs -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-4">K-Ziele / KPI-Ergebnisse</h4>
                    <div id="kpiContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Dynamisch gefüllt basierend auf Teilprojekt -->
                    </div>
                </div>

                <!-- Qualitative Bewertung -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-4">Qualitative Bewertung</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Was lief gut?</label>
                            <textarea name="wasLiefGut" rows="3" 
                                     class="w-full px-3 py-2 bg-yellow-50 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500"
                                     placeholder="Positive Aspekte und Erfolge beschreiben"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Wo gab es Abweichungen?</label>
                            <textarea name="abweichungen" rows="3" 
                                     class="w-full px-3 py-2 bg-yellow-50 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500"
                                     placeholder="Herausforderungen und Abweichungen vom Plan"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Erkenntnisse / Lessons Learned</label>
                            <textarea name="lessonsLearned" rows="3" 
                                     class="w-full px-3 py-2 bg-yellow-50 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500"
                                     placeholder="Wichtige Erkenntnisse für zukünftige Projekte"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Dokumente & Anhänge -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-4">Dokumente & Anhänge</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Rapport-Dokumentation (PDF)</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                                <input type="file" id="rapportDocument" name="rapportDocument" accept=".pdf" class="hidden" onchange="handleFileUpload(this)">
                                <div id="uploadArea" class="cursor-pointer" onclick="document.getElementById('rapportDocument').click()">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                    <p class="mt-2 text-sm text-gray-500">
                                        <span class="font-medium text-blue-600 hover:text-blue-500">Datei hochladen</span> oder per Drag & Drop
                                    </p>
                                    <p class="text-xs text-gray-500">PDF bis 10MB</p>
                                </div>
                                <div id="fileInfo" class="hidden">
                                    <div class="flex items-center justify-center">
                                        <svg class="h-8 w-8 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span id="fileName" class="text-sm font-medium text-gray-900"></span>
                                        <button type="button" onclick="removeFile()" class="ml-2 text-red-500 hover:text-red-700">
                                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Zusätzliche Hinweise zu Dokumenten</label>
                            <textarea name="dokumenteHinweise" rows="2" placeholder="Beschreibung der hochgeladenen Dokumente..." class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row justify-between items-center pt-4 border-t gap-4">
                    <div>
                        <button type="button" onclick="saveAsDraft()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            Als Entwurf speichern
                        </button>
                    </div>
                    <div class="flex gap-4">
                        <button type="button" onclick="closeModal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                            Abbrechen
                        </button>
                        <button type="button" onclick="submitForReview()" class="px-6 py-2 bg-[var(--color-secondary)] text-white rounded-lg hover:bg-green-700">
                            Zur Prüfung einreichen
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- View Rapport Modal -->
    <div id="viewRapportModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-6xl shadow-lg rounded-lg bg-white m-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900" id="viewModalTitle">Rapport Details</h3>
                <button onclick="closeViewModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div id="viewRapportContent" class="space-y-6">
                <!-- Content will be loaded here -->
            </div>

            <div class="mt-6 flex justify-end gap-3">
                <button onclick="closeViewModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                    Schliessen
                </button>
                <button onclick="editFromView()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Bearbeiten
                </button>
            </div>
        </div>
    </div>

    <!-- Load unified sidebar component -->
    <script src="../assets/js/fix-user-consistency.js"></script>
    <script src="../assets/js/smooth-navigation.js"></script>
    <script src="../assets/js/sidebar-component.js"></script>
    <!-- Mobile Menu Final Solution -->
    <script src="../assets/js/mobile-menu-final.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/templates.js"></script>
    <script>
        // API_BASE_URL aus config.js verwenden
        const API_BASE_URL = window.API_BASE_URL || '';
        console.log('API Base URL:', API_BASE_URL);
        
        // Globale Variablen
        let currentRapportId = null;
        let userRole = 'user'; // Default to user until loaded
        
        // Teilprojekt-Daten werden aus der Datenbank geladen
        let teilprojekte = [];
        
        // Templates werden jetzt dynamisch aus der Datenbank geladen
        // const teilprojektTemplates wird durch TemplateManager.loadTemplatesFromAPI() ersetzt
        let teilprojektTemplates = {}; // Wird beim Laden gefüllt
        
        // ========== UNIVERSELLES DIALOG SYSTEM ==========
        
        /**
         * Zeigt einen benutzerdefinierten Dialog anstatt Browser-Alerts
         */
        function showDialog(options) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('dialogOverlay');
                const title = document.getElementById('dialogTitle');
                const message = document.getElementById('dialogMessage');
                const input = document.getElementById('dialogInput');
                const footer = document.getElementById('dialogFooter');
                
                // Set content
                title.textContent = options.title || 'Hinweis';
                message.innerHTML = options.message || '';
                
                // Icon hinzufügen je nach Typ
                if (options.type === 'warning') {
                    title.innerHTML = `<i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>${title.textContent}`;
                } else if (options.type === 'error') {
                    title.innerHTML = `<i class="fas fa-times-circle text-red-500 mr-2"></i>${title.textContent}`;
                } else if (options.type === 'success') {
                    title.innerHTML = `<i class="fas fa-check-circle text-green-500 mr-2"></i>${title.textContent}`;
                } else if (options.type === 'info') {
                    title.innerHTML = `<i class="fas fa-info-circle text-blue-500 mr-2"></i>${title.textContent}`;
                }
                
                // Handle input field
                if (options.input) {
                    input.classList.remove('hidden');
                    input.value = options.defaultValue || '';
                    input.placeholder = options.placeholder || '';
                } else {
                    input.classList.add('hidden');
                }
                
                // Clear and set buttons
                footer.innerHTML = '';
                
                if (options.buttons) {
                    options.buttons.forEach(btn => {
                        const button = document.createElement('button');
                        button.textContent = btn.text;
                        button.className = btn.className || 'px-4 py-2 rounded-lg transition-colors';
                        
                        // Default styles basierend auf Button-Typ
                        if (btn.type === 'confirm' || btn.type === 'primary') {
                            button.className += ' bg-blue-600 text-white hover:bg-blue-700';
                        } else if (btn.type === 'danger') {
                            button.className += ' bg-red-600 text-white hover:bg-red-700';
                        } else if (btn.type === 'success') {
                            button.className += ' bg-green-600 text-white hover:bg-green-700';
                        } else {
                            button.className += ' bg-gray-300 text-gray-700 hover:bg-gray-400';
                        }
                        
                        button.onclick = () => {
                            overlay.classList.add('hidden');
                            const result = options.input ? input.value : btn.value !== undefined ? btn.value : true;
                            resolve(result);
                        };
                        
                        footer.appendChild(button);
                    });
                } else {
                    // Default OK button
                    const okButton = document.createElement('button');
                    okButton.textContent = 'OK';
                    okButton.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors';
                    okButton.onclick = () => {
                        overlay.classList.add('hidden');
                        resolve(true);
                    };
                    footer.appendChild(okButton);
                }
                
                // Show dialog
                overlay.classList.remove('hidden');
                
                // Focus on input or first button
                setTimeout(() => {
                    if (options.input && !input.classList.contains('hidden')) {
                        input.focus();
                    } else {
                        footer.querySelector('button')?.focus();
                    }
                }, 100);
            });
        }
        
        /**
         * Ersatz für window.confirm()
         */
        async function confirmDialog(message, title = 'Bestätigung') {
            return await showDialog({
                title: title,
                message: message,
                type: 'warning',
                buttons: [
                    { text: 'Abbrechen', type: 'cancel', value: false },
                    { text: 'Bestätigen', type: 'primary', value: true }
                ]
            });
        }
        
        /**
         * Ersatz für window.alert()
         */
        async function alertDialog(message, title = 'Hinweis', type = 'info') {
            return await showDialog({
                title: title,
                message: message,
                type: type,
                buttons: [
                    { text: 'OK', type: 'primary' }
                ]
            });
        }
        
        /**
         * Ersatz für window.prompt()
         */
        async function promptDialog(message, defaultValue = '', title = 'Eingabe') {
            return await showDialog({
                title: title,
                message: message,
                input: true,
                defaultValue: defaultValue,
                type: 'info',
                buttons: [
                    { text: 'Abbrechen', type: 'cancel', value: null },
                    { text: 'OK', type: 'primary' }
                ]
            });
        }
        
        // ========== ENDE DIALOG SYSTEM ==========
        
        // Lade Templates beim Start
        async function loadTemplatesOnStartup() {
            try {
                teilprojektTemplates = await TemplateManager.loadTemplatesFromAPI();
                console.log(`✅ ${Object.keys(teilprojektTemplates).length} Templates aus Datenbank geladen`);
            } catch (error) {
                console.error('Fehler beim Laden der Templates:', error);
                showNotification('Templates konnten nicht geladen werden', 'error');
            }
        }
        
        // ALTE HARDCODIERTE TEMPLATES ENTFERNT - verwende API stattdessen
        const OLD_teilprojektTemplates = {
            'tp1-leitmedien': {
                name: 'TP1 - Leitmedien',
                beschreibung: 'Nationale Medienkampagne zur Stärkung der öffentlichen Wahrnehmung',
                ziele: [
                    'Bekanntheit der Marke von 24% auf 30% steigern',
                    'Positives Image bei 75% der Bevölkerung erreichen',
                    'Wissen über landw. Leistungen von 50% auf 55% erhöhen'
                ],
                gesamtbudget: 1590000,
                massnahmen: [
                    { nr: 1, name: 'Mediakampagne', kanal: 'OOH/DOOH/Social Ads', budgetBrutto: 830000 },
                    { nr: 2, name: 'Werbeartikel', kanal: 'Diverse', budgetBrutto: 470000 },
                    { nr: 3, name: 'Sachinformation Print & Digital', kanal: 'Broschüren', budgetBrutto: 110000 },
                    { nr: 4, name: 'Jahresaktion', kanal: '—', budgetBrutto: 0 },
                    { nr: 5, name: 'Projektentwicklung', kanal: 'n.z.', budgetBrutto: 180000 }
                ],
                kpis: [
                    { name: 'Bekanntheit Marke', einheit: '%', zielwert: 30 },
                    { name: 'Image positiv', einheit: '%', zielwert: 50 },
                    { name: 'Wissen Leistungen', einheit: '%', zielwert: 55 },
                    { name: 'Vertrauen', einheit: '%', zielwert: 50 }
                ]
            },
            'tp2-digitale-medien': {
                name: 'TP2 - Digitale Medien',
                beschreibung: 'Förderung der Wissensplattform und Dialog in sozialen Netzwerken',
                ziele: [
                    '200\'000 Website-Besucher halten',
                    'Social Media Impressions DE: 7 Mio.',
                    '500 neue Newsletter-Abonnenten'
                ],
                gesamtbudget: 490000,
                massnahmen: [
                    { nr: 1, name: 'Internetprojekte', kanal: 'Websites', budgetBrutto: 280000 },
                    { nr: 2, name: 'Social Media', kanal: 'FB/IG/TikTok/YouTube', budgetBrutto: 210000 }
                ],
                kpis: [
                    { name: 'Website-Besucher', einheit: 'Besucher', zielwert: 200000 },
                    { name: 'Aufenthaltsdauer', einheit: 'Sek.', zielwert: 60 },
                    { name: 'Social Media Impressions DE', einheit: 'Mio.', zielwert: 7 },
                    { name: 'Social Media Impressions FR', einheit: 'Mio.', zielwert: 3 },
                    { name: 'Newsletter-Abonnenten neu', einheit: 'Abonnenten', zielwert: 500 }
                ]
            },
            'tp3-messen': {
                name: 'TP3 - Messen & Ausstellungen',
                beschreibung: 'Präsentation landwirtschaftlicher Leistungen durch interaktive Ausstellungen',
                ziele: [
                    '1.2-1.4 Mio. Messebesucher erreichen',
                    '140\'000 Besucher OLMA Themenwelt',
                    '50\'000 aktive Kontakte'
                ],
                gesamtbudget: 630000,
                massnahmen: [
                    { nr: 1, name: 'Messen & Ausstellungen', kanal: 'Publikumsmessen', budgetBrutto: 630000 }
                ],
                kpis: [
                    { name: 'Messebesucher gesamt', einheit: 'Mio.', zielwert: 1.3 },
                    { name: 'OLMA Themenwelt Besucher', einheit: 'Besucher', zielwert: 140000 },
                    { name: 'Aktive Kontakte', einheit: 'Kontakte', zielwert: 50000 },
                    { name: 'Verteilte Broschüren', einheit: 'Broschüren', zielwert: 350000 }
                ]
            },
            'tp4-events': {
                name: 'TP4 - Events & Aktionen',
                beschreibung: 'Förderung des direkten Engagements der Bevölkerung bei Vor-Ort-Veranstaltungen',
                ziele: [
                    '100\'000 Stallvisite-Besucher',
                    '50 neue Vom-Hof-Anbieter',
                    'Mind. 3 Buurehof id Stadt Durchführungen'
                ],
                gesamtbudget: 470000,
                massnahmen: [
                    { nr: 1, name: 'Vom Hof', kanal: 'Bauernportal', budgetBrutto: 80000 },
                    { nr: 2, name: 'Stallvisite', kanal: 'Stallvisite-Betriebe', budgetBrutto: 80000 },
                    { nr: 3, name: 'Tag der offenen Hoftüren', kanal: 'Event', budgetBrutto: 10000 },
                    { nr: 4, name: 'Lockpfosten', kanal: 'Lockpfosten', budgetBrutto: 10000 },
                    { nr: 5, name: 'Buurehof id Stadt', kanal: 'Event', budgetBrutto: 145000 },
                    { nr: 6, name: 'Landwirtschaft im Fokus', kanal: 'Festival/Event', budgetBrutto: 145000 }
                ],
                kpis: [
                    { name: 'Stallvisite Besucher', einheit: 'Besucher', zielwert: 100000 },
                    { name: 'Neue Vom-Hof-Anbieter', einheit: 'Anbieter', zielwert: 50 },
                    { name: 'Buurehof id Stadt Durchführungen', einheit: 'Durchführungen', zielwert: 3 },
                    { name: 'Buurehof id Stadt Kontakte/Tag', einheit: 'Kontakte', zielwert: 2000 },
                    { name: 'Event-Besucher gesamt', einheit: 'Besucher', zielwert: 4000 }
                ]
            },
            'tp5-schulprojekte': {
                name: 'TP5 - Schulprojekte',
                beschreibung: 'Sensibilisierung der jüngeren Generation für nachhaltige Landwirtschaft',
                ziele: [
                    '65\'000 Schüler erreichen',
                    '410 SchuB-Betriebe aktiv',
                    '4\'500 Jugendliche im Unterricht'
                ],
                gesamtbudget: 140000,
                massnahmen: [
                    { nr: 1, name: 'Schulprojekt', kanal: 'Nicht zuordenbar', budgetBrutto: 140000 }
                ],
                kpis: [
                    { name: 'Teilnehmende Schüler', einheit: 'Schüler', zielwert: 65000 },
                    { name: 'SchuB-Betriebe', einheit: 'Betriebe', zielwert: 410 },
                    { name: 'Agro-Image Unterrichte', einheit: 'Unterrichte', zielwert: 4500 }
                ]
            },
            'tp6-partnerprojekte': {
                name: 'TP6 - Partnerprojekte (inkl. KEP)',
                beschreibung: 'Bewusstsein für die Arbeit der Bäuerinnen und Bauern fördern',
                ziele: [
                    '20\'000 Agriviva Einsatztage',
                    '22 aktive Partnerprojekte',
                    'Regional verankerte KEP-Projekte'
                ],
                gesamtbudget: 1090000,
                massnahmen: [
                    { nr: 1, name: 'Agro-Image', kanal: 'Unterricht', budgetBrutto: 70000 },
                    { nr: 2, name: 'Agriviva', kanal: 'Begegnung', budgetBrutto: 110000 },
                    { nr: 3, name: 'Kantonale Ergänzungsprojekte', kanal: 'Nicht zuordenbar', budgetBrutto: 890000 },
                    { nr: 4, name: 'Ergänzende Projekte', kanal: 'Nicht zuordenbar', budgetBrutto: 20000 }
                ],
                kpis: [
                    { name: 'Agriviva Einsatztage', einheit: 'Tage', zielwert: 20000 },
                    { name: 'Agriviva Website-Besucher', einheit: 'Besucher', zielwert: 100000 },
                    { name: 'Aktive Partnerprojekte', einheit: 'Projekte', zielwert: 22 },
                    { name: 'KEP-Projekte', einheit: 'Projekte', zielwert: 20 }
                ]
            }
        };

        // Authentication check
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '../login.html';
                return false;
            }
            return true;
        }

        // Initialisierung
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize unified sidebar
            initializeSidebar('rapport');
            
            // Mobile menu is handled by mobile-menu-final.js
            
            if (!checkAuth()) return;
            
            console.log('Rapport-Management initialisiert');
            checkUserRole();
            loadUserInfo(); // Load user info for sidebar
            loadRapporte();
            setupEventListeners();
            loadTeilprojekte();
            loadKPIs();
            
            // Lade Admin-Rapporte wenn Admin eingeloggt ist
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (user.rolle === 'admin' || user.rolle === 'super_admin') {
                console.log('Admin erkannt - lade Admin-Rapporte');
                // Verzögert laden, damit das DOM bereit ist
                setTimeout(() => {
                    loadAdminRapporte();
                }, 500);
            }
        });

        function checkUserRole() {
            const user = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
            userRole = user.rolle || 'admin';
            console.log('Aktuelle Benutzerrolle:', userRole);
        }

        function setupEventListeners() {
            // Teilprojekt-Auswahl Handler
            const teilprojektSelect = document.querySelector('select[name="teilprojekt"]');
            if (teilprojektSelect) {
                teilprojektSelect.addEventListener('change', function(e) {
                    loadTeilprojektTemplate(e.target.value);
                });
            }

            // Filter Handler
            document.getElementById('jahrFilter').addEventListener('change', filterRapporte);
            document.getElementById('statusFilter').addEventListener('change', filterRapporte);
            document.getElementById('teilprojektFilter').addEventListener('change', filterRapporte);
        }

        async function loadTeilprojektTemplate(teilprojektKey) {
            console.log('loadTeilprojektTemplate aufgerufen mit:', teilprojektKey);
            
            if (!teilprojektKey) {
                // Clear template fields
                document.getElementById('massnahmenContainer').innerHTML = '';
                document.getElementById('kpiContainer').innerHTML = '';
                document.getElementById('budgetBruttoField').value = '';
                
                // Hide details container
                const detailsContainer = document.getElementById('teilprojektDetailsContainer');
                if (detailsContainer) {
                    detailsContainer.classList.add('hidden');
                }
                
                console.log('Template-Felder geleert');
                return;
            }

            // Versuche Template aus Cache zu holen, sonst von API laden
            let template = teilprojektTemplates[teilprojektKey];
            if (!template) {
                console.log('Template nicht im Cache, lade von API:', teilprojektKey);
                template = await TemplateManager.loadSpecificTemplate(teilprojektKey);
                if (!template) {
                    console.error('Template nicht gefunden für:', teilprojektKey);
                    showNotification('Template konnte nicht geladen werden', 'error');
                    return;
                }
                // Füge zum Cache hinzu
                teilprojektTemplates[teilprojektKey] = template;
            }

            console.log('Lade Template für:', template.name);
            console.log('Budget:', template.gesamtbudget);
            console.log('Massnahmen:', template.massnahmen.length);
            console.log('KPIs:', template.kpis.length);

            // Zeige Teilprojekt-Details
            const detailsContainer = document.getElementById('teilprojektDetailsContainer');
            if (detailsContainer) {
                detailsContainer.classList.remove('hidden');
                
                // Get current user role
                const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
                const isAdmin = currentUser.role === 'admin' || currentUser.role === 'super_admin';
                
                // Befülle die Felder - mit sicheren Fallbacks
                const nameField = document.getElementById('teilprojektNameField');
                if (nameField) {
                    nameField.value = template.name || template.template_name || '';
                }
                
                const beschreibungField = document.getElementById('teilprojektBeschreibungField');
                if (beschreibungField) {
                    beschreibungField.value = template.beschreibung || '';
                }
                
                // Ziele können Array oder undefined sein
                const zieleField = document.getElementById('teilprojektZieleField');
                if (zieleField) {
                    if (Array.isArray(template.ziele)) {
                        zieleField.value = template.ziele.join('\n');
                    } else if (typeof template.ziele === 'string') {
                        zieleField.value = template.ziele;
                    } else {
                        zieleField.value = '';
                    }
                }
                
                // Budget mit Fallback
                const budgetField = document.getElementById('teilprojektBudgetField');
                if (budgetField) {
                    const budget = template.gesamtbudget || 0;
                    budgetField.value = `CHF ${budget.toLocaleString('de-CH')}`;
                }
                
                // Massnahmen Count mit Fallback
                const massnahmenCountField = document.getElementById('teilprojektMassnahmenCountField');
                if (massnahmenCountField) {
                    const massnahmenCount = Array.isArray(template.massnahmen) ? template.massnahmen.length : 0;
                    massnahmenCountField.value = massnahmenCount;
                }
                
                // K-Zielbezug - Standardtext oder leer
                document.getElementById('teilprojektKZielbezugField').value = template.kZielbezug || 
                    'Die Kommunikationsziele dieses Teilprojekts tragen zur Erreichung der übergeordneten Ziele bei.';
                
                // Setze readonly Status basierend auf Benutzerrolle
                // Name, Budget und Anzahl Massnahmen sind immer readonly
                const alwaysReadonlyFields = [
                    'teilprojektNameField',
                    'teilprojektBudgetField',
                    'teilprojektMassnahmenCountField'
                ];
                
                // Beschreibung und Ziele können von allen Usern bearbeitet werden
                const userEditableFields = [
                    'teilprojektBeschreibungField', 
                    'teilprojektZieleField'
                ];
                
                // Always readonly fields
                alwaysReadonlyFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.classList.add('bg-gray-50');
                        field.readOnly = true;
                    }
                });
                
                // User editable fields - jetzt für alle User editierbar
                userEditableFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        // Alle User können diese Felder bearbeiten
                        field.classList.add('bg-yellow-50', 'hover:bg-yellow-100');
                        field.readOnly = false;
                    }
                });
                
                // K-Zielbezug ist für alle editierbar (gelbes Feld)
                const kZielField = document.getElementById('teilprojektKZielbezugField');
                if (kZielField) {
                    kZielField.classList.remove('bg-gray-50');
                    kZielField.classList.add('bg-yellow-50', 'border-yellow-300');
                    kZielField.readOnly = false;
                }
            }

            // Set budget (grau - vorhandene Daten)
            const budgetField = document.getElementById('budgetBruttoField');
            if (budgetField) {
                budgetField.value = template.gesamtbudget.toLocaleString('de-CH');
                console.log('Budget gesetzt');
            } else {
                console.error('Budget-Feld nicht gefunden');
            }

            // Load Massnahmen - mit Fallback auf leeres Array und Transformation
            console.log('Lade Massnahmen...');
            let massnahmen = [];
            if (Array.isArray(template.massnahmen)) {
                // Transformiere DB-Format zu Frontend-Format
                massnahmen = template.massnahmen.map((m, index) => ({
                    nr: m.nr || m.id || (index + 1),
                    name: m.name || m.beschreibung || `Massnahme ${index + 1}`,
                    budgetBrutto: m.budgetBrutto || m.budget || 0,
                    istBrutto: m.istBrutto || 0,
                    aufwandsminderung: m.aufwandsminderung || 0,
                    kostenNetto: m.kostenNetto || 0,
                    streukosten: m.streukosten || 0,
                    produktionskosten: m.produktionskosten || 0,
                    overhead: m.overhead || 0
                }));
            }
            console.log('Transformierte Massnahmen:', massnahmen);
            loadMassnahmen(massnahmen);

            // Load KPIs - mit Fallback auf leeres Array und minimaler Transformation
            console.log('Lade KPIs...');
            let kpis = [];
            if (Array.isArray(template.kpis)) {
                // Minimale Transformation - behalte Original-Struktur bei
                kpis = template.kpis.map(kpi => ({
                    ...kpi, // Behalte alle Original-Felder
                    name: kpi.name || kpi.title || 'KPI',
                    zielwert: kpi.zielwert || kpi.target || kpi.ziel || '0',
                    einheit: kpi.einheit || kpi.unit || '',
                    description: kpi.description || kpi.beschreibung || ''
                }));
            }
            console.log('Transformierte KPIs:', kpis);
            loadKPIsForTeilprojekt(kpis);
            
            console.log('Template vollständig geladen');
        }

        function loadMassnahmen(massnahmen) {
            const container = document.getElementById('massnahmenContainer');
            
            if (!container) {
                console.error('massnahmenContainer nicht gefunden');
                return;
            }
            
            // Sicherheitscheck
            if (!Array.isArray(massnahmen)) {
                console.warn('Massnahmen ist kein Array, verwende leeres Array');
                massnahmen = [];
            }
            
            // Get current user role from localStorage or default to user
            const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
            const currentUserRole = currentUser.role || 'user';
            const canEditGrayFields = true; // Alle User können graue Felder bearbeiten
            
            console.log('Lade', massnahmen.length, 'Massnahmen');
            console.log('User Role:', currentUserRole, 'Kann graue Felder bearbeiten:', canEditGrayFields);
            
            container.innerHTML = `
                <div class="overflow-x-auto">
                    <p class="text-sm text-gray-600 mb-2">Bitte wählen Sie für jede Massnahme die zutreffenden K-Ziele aus (Mehrfachauswahl mit Strg/Cmd möglich):</p>
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-2 py-2 text-left w-48">Massnahme</th>
                                <th class="px-2 py-2 text-left w-28">Budget Brutto</th>
                                <th class="px-2 py-2 text-left w-28">IST Brutto</th>
                                <th class="px-2 py-2 text-left w-32">Aufwandsminderung</th>
                                <th class="px-2 py-2 text-left w-28">Kosten Netto</th>
                                <th class="px-2 py-2 text-left w-28">Streukosten</th>
                                <th class="px-2 py-2 text-left w-32">Produktionskosten</th>
                                <th class="px-2 py-2 text-left w-24">Overhead</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${massnahmen.map((massnahme, index) => {
                                const nr = massnahme.nr || (index + 1);
                                const name = massnahme.name || `Massnahme ${nr}`;
                                const budgetBrutto = massnahme.budgetBrutto || 0;
                                
                                return `
                                <tr>
                                    <td class="px-2 py-2">
                                        <div class="space-y-1">
                                            <div class="flex items-start">
                                                <span class="mr-2 text-gray-500 mt-1">${nr}.</span>
                                                <div class="flex-grow">
                                                    <div class="text-sm font-medium text-gray-900 mb-1">${name}</div>
                                                    <select name="kZielBezug_${nr}" 
                                                           class="w-full px-2 py-1 text-xs bg-yellow-50 border border-yellow-300 rounded focus:ring-2 focus:ring-yellow-500"
                                                           multiple size="2">
                                                        <option value="1">K-Ziel 1: Wissen</option>
                                                        <option value="2">K-Ziel 2: Sympathie</option>
                                                        <option value="3">K-Ziel 3: Präferenz</option>
                                                        <option value="4">K-Ziel 4: Nachhaltigkeit</option>
                                                        <option value="5">K-Ziel 5: Weitere</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-2 py-2">
                                        <input type="text" ${canEditGrayFields ? '' : 'readonly'} value="CHF ${budgetBrutto.toLocaleString('de-CH')}" 
                                               class="w-full px-2 py-1 text-sm bg-gray-50 border border-gray-300 rounded ${canEditGrayFields ? 'hover:bg-gray-100' : ''}">
                                    </td>
                                    <td class="px-2 py-2">
                                        <input type="number" name="istBrutto_${nr}" 
                                               class="w-full px-2 py-1 text-sm bg-yellow-50 border border-yellow-300 rounded focus:ring-2 focus:ring-yellow-500" 
                                               placeholder="IST Brutto"
                                               onchange="calculateMassnahmeNetto(${nr})">
                                    </td>
                                    <td class="px-2 py-2">
                                        <input type="number" name="aufwandsminderung_${nr}" 
                                               class="w-full px-2 py-1 text-sm bg-gray-100 border border-gray-300 rounded" 
                                               placeholder="10% auto"
                                               readonly>
                                    </td>
                                    <td class="px-2 py-2">
                                        <input type="text" readonly id="kostenNetto_${nr}" 
                                               class="w-full px-2 py-1 text-sm bg-gray-50 border border-gray-300 rounded" 
                                               placeholder="Kosten Netto">
                                    </td>
                                    <td class="px-2 py-2">
                                        <input type="number" name="streukosten_${nr}" 
                                               class="w-full px-2 py-1 text-sm bg-yellow-50 border border-yellow-300 rounded focus:ring-2 focus:ring-yellow-500" 
                                               placeholder="Streu Kosten"
                                               onchange="calculateMassnahmenTotals()">
                                    </td>
                                    <td class="px-2 py-2">
                                        <input type="number" name="produktionskosten_${nr}" 
                                               class="w-full px-2 py-1 text-sm bg-yellow-50 border border-yellow-300 rounded focus:ring-2 focus:ring-yellow-500" 
                                               placeholder="Produktionskoste"
                                               onchange="calculateMassnahmenTotals()">
                                    </td>
                                    <td class="px-2 py-2">
                                        <input type="number" name="overhead_${nr}" 
                                               class="w-full px-2 py-1 text-sm bg-yellow-50 border border-yellow-300 rounded focus:ring-2 focus:ring-yellow-500" 
                                               placeholder="Overhead"
                                               onchange="calculateMassnahmenTotals()">
                                    </td>
                                </tr>
                            `}).join('')}
                            <tr class="border-t-2 border-gray-400 font-semibold bg-gray-100">
                                <td class="px-2 py-2">Total</td>
                                <td class="px-2 py-2">
                                    <input type="text" readonly id="totalBudgetBrutto" 
                                           class="w-full px-2 py-1 text-sm bg-gray-200 border border-gray-300 rounded font-semibold" 
                                           value="CHF ${massnahmen.reduce((sum, m) => sum + (m.budgetBrutto || m.budget || 0), 0).toLocaleString('de-CH')}">
                                </td>
                                <td class="px-2 py-2">
                                    <input type="text" readonly id="totalIstBrutto" 
                                           class="w-full px-2 py-1 text-sm bg-gray-200 border border-gray-300 rounded font-semibold" 
                                           placeholder="Total IST">
                                </td>
                                <td class="px-2 py-2">
                                    <input type="text" readonly id="totalAufwandsminderung" 
                                           class="w-full px-2 py-1 text-sm bg-gray-200 border border-gray-300 rounded font-semibold" 
                                           placeholder="Total Minderung">
                                </td>
                                <td class="px-2 py-2">
                                    <input type="text" readonly id="totalKostenNetto" 
                                           class="w-full px-2 py-1 text-sm bg-gray-200 border border-gray-300 rounded font-semibold" 
                                           placeholder="Total Netto">
                                </td>
                                <td class="px-2 py-2">
                                    <input type="text" readonly id="totalStreukosten" 
                                           class="w-full px-2 py-1 text-sm bg-gray-200 border border-gray-300 rounded font-semibold" 
                                           placeholder="Total Streu">
                                </td>
                                <td class="px-2 py-2">
                                    <input type="text" readonly id="totalProduktionskosten" 
                                           class="w-full px-2 py-1 text-sm bg-gray-200 border border-gray-300 rounded font-semibold" 
                                           placeholder="Total Prod">
                                </td>
                                <td class="px-2 py-2">
                                    <input type="text" readonly id="totalOverhead" 
                                           class="w-full px-2 py-1 text-sm bg-gray-200 border border-gray-300 rounded font-semibold" 
                                           placeholder="Total Overhead">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function loadKPIsForTeilprojekt(kpis) {
            console.log('loadKPIsForTeilprojekt aufgerufen mit:', kpis);
            const container = document.getElementById('kpiContainer');
            if (!container) {
                console.error('KPI Container nicht gefunden!');
                return;
            }
            
            // Get current user role from localStorage
            const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
            const currentUserRole = currentUser.role || 'user';
            const canEditGrayFields = true; // Alle User können graue Felder bearbeiten
            
            console.log('KPI Container gefunden, lade KPIs:', kpis);
            console.log('User Role für KPIs:', currentUserRole, 'Kann graue Felder bearbeiten:', canEditGrayFields);
            
            if (!kpis || kpis.length === 0) {
                container.innerHTML = '<p class="text-gray-500 p-4">Keine KPIs für dieses Teilprojekt definiert.</p>';
                console.log('Keine KPIs vorhanden');
                return;
            }
            
            const kpiHTML = kpis.map(kpi => {
                // Sichere Werte mit Fallbacks
                const name = kpi.name || 'KPI';
                const einheit = kpi.einheit || kpi.unit || '';
                
                // Zielwert kann String oder Zahl sein
                let zielwertDisplay = '';
                if (kpi.zielwert !== undefined && kpi.zielwert !== null) {
                    // Wenn es schon ein String mit Einheit ist (z.B. "2.5 Mio")
                    if (typeof kpi.zielwert === 'string') {
                        zielwertDisplay = kpi.zielwert;
                        // Füge Einheit nur hinzu wenn noch nicht im String
                        if (einheit && !kpi.zielwert.includes(einheit)) {
                            zielwertDisplay += ` ${einheit}`;
                        }
                    } else if (typeof kpi.zielwert === 'number') {
                        zielwertDisplay = `${kpi.zielwert.toLocaleString('de-CH')} ${einheit}`;
                    }
                } else if (kpi.target !== undefined && kpi.target !== null) {
                    // Fallback auf 'target' Feld
                    if (typeof kpi.target === 'string') {
                        zielwertDisplay = kpi.target;
                    } else {
                        zielwertDisplay = `${kpi.target.toLocaleString('de-CH')} ${einheit}`;
                    }
                } else {
                    zielwertDisplay = `0 ${einheit}`;
                }
                
                console.log('Erstelle KPI:', name, 'Ziel:', zielwertDisplay);
                
                const safeId = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
                
                return `
                    <div class="bg-white p-4 border border-gray-200 rounded-lg shadow-sm">
                        <div class="mb-3">
                            <label class="block text-xs font-medium text-gray-700 mb-1">KPI-Name</label>
                            <input type="text" ${canEditGrayFields ? '' : 'readonly'} value="${name}" 
                                   class="w-full px-3 py-2 text-sm font-semibold bg-gray-50 border border-gray-300 rounded ${canEditGrayFields ? 'hover:bg-gray-100' : ''}"
                                   name="kpi_name_${safeId}">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Zielwert</label>
                                <input type="text" ${canEditGrayFields ? '' : 'readonly'} value="${zielwertDisplay}" 
                                       class="w-full px-3 py-2 text-sm bg-gray-50 border border-gray-300 rounded ${canEditGrayFields ? 'hover:bg-gray-100' : ''}"
                                       name="kpi_target_${safeId}">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">IST-Wert</label>
                                <input type="number" name="kpi_${safeId}" 
                                       class="w-full px-3 py-2 text-sm bg-yellow-50 border border-yellow-300 rounded focus:ring-2 focus:ring-yellow-500" 
                                       placeholder="Eingabe erforderlich">
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = kpiHTML;
            console.log('KPIs HTML gesetzt, Anzahl:', kpis.length);
            console.log('Container HTML:', container.innerHTML.substring(0, 200) + '...');
        }

        async function loadKPIDashboard() {
            try {
                console.log('Lade KPI-Dashboard...');
                const token = localStorage.getItem('authToken');
                
                // Jahr-Filter berücksichtigen
                const jahrFilter = document.getElementById('jahrFilter')?.value || '2024';
                const queryParams = new URLSearchParams({ year: jahrFilter });
                
                const response = await fetch(`${API_BASE_URL}/api/budget/kpis?${queryParams}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const kpis = await response.json();
                    console.log(`Budget-KPIs für Jahr ${jahrFilter} geladen:`, kpis);
                    updateKPIDisplay(kpis);
                } else {
                    console.log('Budget-API nicht verfügbar - berechne aus Rapporte');
                    calculateKPIsFromRapporte();
                }
            } catch (error) {
                console.error('KPI-Fehler:', error);
                calculateKPIsFromRapporte();
            }
        }

        function updateKPIDisplay(kpis) {
            console.log('Aktualisiere KPI-Anzeige:', kpis);
            
            // Debug info anzeigen
            if (kpis.debug) {
                console.log('Debug Info:', kpis.debug);
            }
            
            // Update Gesamtbudget
            const budgetElement = document.getElementById('totalBudget');
            if (budgetElement && kpis.totalBudget) {
                budgetElement.textContent = `CHF ${kpis.totalBudget.toLocaleString('de-CH')}`;
            }
            
            // Update Ausgegeben
            const spentElement = document.getElementById('spentBudget');
            if (spentElement && kpis.spent) {
                spentElement.textContent = `CHF ${kpis.spent.toLocaleString('de-CH')}`;
                
                // Update Progress Bar
                const progressElement = document.getElementById('budgetProgress');
                if (progressElement && kpis.totalBudget > 0) {
                    const percentage = Math.round((kpis.spent / kpis.totalBudget) * 100);
                    progressElement.style.width = `${percentage}%`;
                    spentElement.nextElementSibling.textContent = `${percentage}% verbraucht`;
                }
            }
            
            // Update Budget-Auslastung
            const utilizationElement = document.getElementById('budgetUtilization');
            if (utilizationElement && typeof kpis.utilization !== 'undefined') {
                utilizationElement.textContent = `${kpis.utilization}%`;
            }
            
            // Update Aktive Rapporte
            const activeElement = document.getElementById('activeReports');
            if (activeElement && typeof kpis.openReports !== 'undefined') {
                activeElement.textContent = kpis.openReports;
            }
        }

        async function calculateKPIsFromRapporte() {
            // Fallback: Berechne KPIs aus geladenen Rapport-Daten oder verwende Backend-Standard
            console.log('Berechne KPIs aus verfügbaren Daten...');
            
            const jahrFilter = document.getElementById('jahrFilter')?.value || '2024';
            
            // Definiere Budgets für verschiedene Jahre (Frontend-Fallback)
            const BUDGETS_BY_YEAR = {
                '2024': 4410000  // CHF 4.41 Mio - aus den 6 Teilprojekten
                // Weitere Jahre bei Bedarf ergänzen
            };
            
            const totalBudget = BUDGETS_BY_YEAR[jahrFilter] || 0;
            
            // Wenn keine Backend-Daten verfügbar, zeige realistische Werte
            const spent = 0; // Keine Ausgaben ohne genehmigte Rapporte
            const fallbackKPIs = {
                year: jahrFilter,
                totalBudget: totalBudget,
                spent: spent,
                utilization: 0,
                openReports: 0,
                kpiAchievement: 0,
                debug: {
                    message: `Fallback-Werte für Jahr ${jahrFilter} - Backend nicht erreichbar`
                }
            };
            
            updateKPIDisplay(fallbackKPIs);
        }

        // Removed duplicate loadRapporte function - using the one at line 2226

        function displayRapporte(rapporte) {
            const tbody = document.getElementById('rapportTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = rapporte.map(rapport => {
                // Parse content to get budget data
                let budgetVarianz = 0;
                let fortschritt = 50;
                try {
                    const content = typeof rapport.content === 'string' ? JSON.parse(rapport.content) : rapport.content;
                    if (content.budgetBrutto && content.istBrutto) {
                        const budget = parseFloat(content.budgetBrutto) || 0;
                        const ist = parseFloat(content.istBrutto) || 0;
                        if (budget > 0) {
                            budgetVarianz = ((ist - budget) / budget * 100).toFixed(1);
                        }
                    }
                    // Calculate progress based on status
                    const statusProgress = {
                        'entwurf': 20,
                        'eingereicht': 40,
                        'in_bearbeitung': 60,
                        'fertig': 80,
                        'genehmigt': 100,
                        'abgelehnt': 100
                    };
                    fortschritt = statusProgress[rapport.status] || 50;
                } catch (e) {
                    console.error('Error parsing rapport content:', e);
                }
                
                return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-4">${rapport.id}</td>
                    <td class="py-3 px-4">${formatTeilprojektName(rapport.category) || 'Allgemein'}</td>
                    <td class="py-3 px-4">${new Date(rapport.created_at).toLocaleDateString('de-CH')}</td>
                    <td class="py-3 px-4">
                        <span class="status-badge status-${rapport.status}">${formatStatus(rapport.status)}</span>
                    </td>
                    <td class="py-3 px-4">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${fortschritt}%"></div>
                        </div>
                        <span class="text-xs text-gray-500">${fortschritt}%</span>
                    </td>
                    <td class="py-3 px-4">
                        ${formatBudgetVarianz(budgetVarianz)}
                    </td>
                    <td class="py-3 px-4">
                        ${getActionButtons(rapport)}
                    </td>
                </tr>
            `}).join('');
        }

        // View rapport details
        async function viewRapport(rapportId) {
            console.log('Öffne Rapport:', rapportId);
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    showNotification('Bitte melden Sie sich an', 'error');
                    return;
                }
                
                console.log('Lade Rapport vom Server...');
                const response = await fetch(`${API_BASE_URL}/api/rapporte/${rapportId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('Response Status:', response.status);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        showNotification('Rapport nicht gefunden', 'error');
                    } else if (response.status === 401) {
                        showNotification('Keine Berechtigung', 'error');
                    } else {
                        showNotification('Fehler beim Laden des Rapports', 'error');
                    }
                    return;
                }
                
                const result = await response.json();
                console.log('API Response:', result);
                const rapport = result.rapport;
                
                if (!rapport) {
                    console.error('Keine Rapport-Daten in Response');
                    showNotification('Rapport-Daten nicht verfügbar', 'error');
                    return;
                }
                
                console.log('Rapport geladen:', rapport);
                
                // Map SQLite field names
                if (rapport.titel && !rapport.title) rapport.title = rapport.titel;
                if (rapport.beschreibung && !rapport.content) rapport.content = rapport.beschreibung;
                
                // Parse content if it's JSON
                let parsedContent = {};
                try {
                    const contentToParse = rapport.content || rapport.beschreibung || '{}';
                    if (typeof contentToParse === 'string' && contentToParse.startsWith('{')) {
                        parsedContent = JSON.parse(contentToParse);
                    } else {
                        parsedContent = { text: contentToParse };
                    }
                } catch (e) {
                    console.log('Content is not JSON:', e);
                    parsedContent = { text: rapport.content || rapport.beschreibung || 'Kein Inhalt' };
                }
                
                console.log('Parsed Content:', parsedContent);
                console.log('Erstelle Modal...');
                    
                    // Create view modal
                    const viewModal = document.createElement('div');
                    viewModal.className = 'fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50';
                    viewModal.innerHTML = `
                        <div class="bg-white rounded-lg p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-6 border-b pb-4">
                                <h2 class="text-2xl font-semibold">Rapport Details</h2>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-6">
                                <div>
                                    <h3 class="text-lg font-semibold mb-4">Basis-Informationen</h3>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="text-sm font-medium text-gray-500">Rapport ID</label>
                                            <p class="text-base font-medium">${rapport.id}</p>
                                        </div>
                                        
                                        <div>
                                            <label class="text-sm font-medium text-gray-500">Titel</label>
                                            <p class="text-base font-medium">${rapport.title || formatTeilprojektName(rapport.category) || 'Kein Titel'}</p>
                                        </div>
                                        
                                        <div>
                                            <label class="text-sm font-medium text-gray-500">Teilprojekt</label>
                                            <p class="text-base font-medium">${formatTeilprojektName(rapport.category) || 'Allgemein'}</p>
                                        </div>
                                        
                                        <div>
                                            <label class="text-sm font-medium text-gray-500">Status</label>
                                            <span class="status-badge status-${rapport.status}">${formatStatus(rapport.status)}</span>
                                        </div>
                                        
                                        <div>
                                            <label class="text-sm font-medium text-gray-500">Erstellt am</label>
                                            <p class="text-base">${new Date(rapport.created_at).toLocaleString('de-CH')}</p>
                                        </div>
                                        
                                        <div>
                                            <label class="text-sm font-medium text-gray-500">Zuletzt aktualisiert</label>
                                            <p class="text-base">${new Date(rapport.updated_at).toLocaleString('de-CH')}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 class="text-lg font-semibold mb-4">Budget & KPIs</h3>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="text-sm font-medium text-gray-500">Jahr</label>
                                            <p class="text-base font-medium">${parsedContent.jahr || '2024'}</p>
                                        </div>
                                        
                                        <div>
                                            <label class="text-sm font-medium text-gray-500">Periode</label>
                                            <p class="text-base font-medium">${parsedContent.periode || 'Q1-2024'}</p>
                                        </div>
                                        
                                        <div>
                                            <label class="text-sm font-medium text-gray-500">Budget Brutto</label>
                                            <p class="text-base font-medium">CHF ${parsedContent.budgetBrutto ? Number(parsedContent.budgetBrutto).toLocaleString('de-CH') : '0'}</p>
                                        </div>
                                        
                                        <div>
                                            <label class="text-sm font-medium text-gray-500">Ist Brutto</label>
                                            <p class="text-base font-medium">CHF ${parsedContent.istBrutto ? Number(parsedContent.istBrutto).toLocaleString('de-CH') : '0'}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${parsedContent.wasLiefGut || parsedContent.abweichungen || parsedContent.lessonsLearned ? `
                            <div class="mt-6 border-t pt-6">
                                <h3 class="text-lg font-semibold mb-4">Weitere Informationen</h3>
                                ${parsedContent.wasLiefGut ? `
                                <div class="mb-4">
                                    <label class="text-sm font-medium text-gray-500">Was lief gut</label>
                                    <div class="bg-gray-50 p-3 rounded mt-1">
                                        <p class="text-base">${parsedContent.wasLiefGut}</p>
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${parsedContent.abweichungen ? `
                                <div class="mb-4">
                                    <label class="text-sm font-medium text-gray-500">Abweichungen</label>
                                    <div class="bg-gray-50 p-3 rounded mt-1">
                                        <p class="text-base">${parsedContent.abweichungen}</p>
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${parsedContent.lessonsLearned ? `
                                <div class="mb-4">
                                    <label class="text-sm font-medium text-gray-500">Lessons Learned</label>
                                    <div class="bg-gray-50 p-3 rounded mt-1">
                                        <p class="text-base">${parsedContent.lessonsLearned}</p>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            ` : ''}
                            
                            <div class="mt-6 flex justify-end gap-3">
                                <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                                    Schliessen
                                </button>
                                <button onclick="editRapport('${rapport.id}'); this.closest('.fixed').remove()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Bearbeiten
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(viewModal);
                    console.log('Modal wurde dem DOM hinzugefügt');
                    showNotification('Rapport wird angezeigt', 'success');
                    
            } catch (error) {
                console.error('Error viewing rapport:', error);
                showNotification('Fehler beim Laden des Rapports: ' + error.message, 'error');
            }
        }
        
        // Edit rapport
        async function editRapport(rapportId) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/rapporte/${rapportId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const rapport = result.rapport;
                    
                    // Parse the content JSON if it's a string
                    let contentData = {};
                    if (rapport.content) {
                        try {
                            contentData = typeof rapport.content === 'string' 
                                ? JSON.parse(rapport.content) 
                                : rapport.content;
                        } catch (e) {
                            console.error('Error parsing rapport content:', e);
                        }
                    }
                    
                    // Open edit modal with rapport data
                    currentRapportId = rapportId;
                    document.getElementById('modalTitle').textContent = 'Rapport bearbeiten';
                    
                    // Reset form first
                    document.getElementById('rapportForm').reset();
                    
                    // Fill basic form data
                    const teilprojektSelect = document.getElementById('teilprojektSelect');
                    if (teilprojektSelect && contentData.teilprojekt) {
                        // Map the teilprojekt value to the select option value
                        const teilprojektMap = {
                            'TP1 - Leitmedien': 'tp1-leitmedien',
                            'TP2 - Digitale Medien': 'tp2-digitale-medien',
                            'TP3 - Messen & Ausstellungen': 'tp3-messen',
                            'TP4 - Events & Aktionen': 'tp4-events',
                            'TP5 - Schulprojekte': 'tp5-schulprojekte',
                            'TP6 - Partnerprojekte (inkl. KEP)': 'tp6-partnerprojekte'
                        };
                        
                        const mappedValue = teilprojektMap[contentData.teilprojekt] || contentData.teilprojekt;
                        teilprojektSelect.value = mappedValue;
                        
                        // Trigger change to load the template
                        teilprojektSelect.dispatchEvent(new Event('change'));
                        
                        // Wait a bit for template to load, then fill in the data
                        setTimeout(() => {
                            // Fill in all the saved data
                            if (contentData.jahr) {
                                const jahrSelect = document.querySelector('select[name="jahr"]');
                                if (jahrSelect) jahrSelect.value = contentData.jahr;
                            }
                            
                            if (contentData.periode) {
                                const periodeSelect = document.querySelector('select[name="periode"]');
                                if (periodeSelect) periodeSelect.value = contentData.periode;
                            }
                            
                            // Fill in Massnahmen KZL selections if they exist
                            if (contentData.massnahmen) {
                                Object.keys(contentData.massnahmen).forEach(key => {
                                    const select = document.querySelector(`select[name="${key}"]`);
                                    if (select && contentData.massnahmen[key]) {
                                        // Clear previous selections
                                        Array.from(select.options).forEach(option => option.selected = false);
                                        
                                        // Set new selections
                                        const values = Array.isArray(contentData.massnahmen[key]) 
                                            ? contentData.massnahmen[key] 
                                            : [contentData.massnahmen[key]];
                                        
                                        values.forEach(value => {
                                            const option = select.querySelector(`option[value="${value}"]`);
                                            if (option) option.selected = true;
                                        });
                                    }
                                });
                            }
                            
                            // Fill in KPI IST values if they exist
                            if (contentData.kpis) {
                                Object.keys(contentData.kpis).forEach(key => {
                                    const input = document.querySelector(`input[name="${key}"]`);
                                    if (input) {
                                        input.value = contentData.kpis[key];
                                    }
                                });
                            }
                            
                            // Fill in text areas and other inputs
                            const fieldsToFill = [
                                'zieleinschaetzung', 'massnahmenDetails', 'zielgruppenErreichung',
                                'medienresonanz', 'partnerFeedback', 'weitereEffekte',
                                'zusammenfassung', 'abgeschlosseneAktivitaeten', 'laufendeAktivitaeten',
                                'geplanteAktivitaeten', 'herausforderungen', 'verbesserungen',
                                'empfehlungen', 'ausblick', 'liefGut', 'abweichungen', 'lessonsLearned'
                            ];
                            
                            fieldsToFill.forEach(fieldName => {
                                if (contentData[fieldName]) {
                                    const field = document.querySelector(`[name="${fieldName}"]`);
                                    if (field) field.value = contentData[fieldName];
                                }
                            });
                            
                        }, 500); // Give template time to load
                    }
                    
                    // Show the modal
                    document.getElementById('rapportModal').classList.remove('hidden');
                    
                    showNotification('Rapport geladen. Sie können jetzt bearbeiten.', 'info');
                } else {
                    showNotification('Fehler beim Laden des Rapports', 'error');
                }
            } catch (error) {
                console.error('Error loading rapport for edit:', error);
                showNotification('Netzwerkfehler beim Laden des Rapports', 'error');
            }
        }

        async function loadTeilprojekte() {
            const container = document.getElementById('teilprojekteContainer');
            if (!container) return;
            
            try {
                console.log('Lade Teilprojekte...');
                
                // Stelle sicher dass Templates geladen sind
                if (!teilprojektTemplates || Object.keys(teilprojektTemplates).length === 0) {
                    await loadTemplatesOnStartup();
                }
                
                // Debug: Zeige was wir haben
                console.log('Verfügbare Templates:', teilprojektTemplates);
                
                if (!teilprojektTemplates || Object.keys(teilprojektTemplates).length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-8 text-gray-500">
                            <p>Keine Teilprojekte verfügbar</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = Object.entries(teilprojektTemplates).map(([key, template]) => {
                    // Sichere Zugriffe mit Fallbacks
                    const name = template.name || key;
                    const beschreibung = template.beschreibung || 'Keine Beschreibung verfügbar';
                    const gesamtbudget = template.gesamtbudget || 0;
                    const ziele = template.ziele || [];
                    const massnahmen = template.massnahmen || [];
                    const kpis = template.kpis || [];
                    
                    return `
                        <div class="bg-white p-6 rounded-lg shadow-sm border">
                            <h3 class="text-lg font-semibold mb-2">${name}</h3>
                            <p class="text-sm text-gray-600 mb-4">${beschreibung}</p>
                            
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Gesamtbudget:</span>
                                    <span class="font-semibold">CHF ${gesamtbudget.toLocaleString('de-CH')}</span>
                                </div>
                                
                                ${ziele.length > 0 ? `
                                    <div>
                                        <span class="text-gray-600 font-medium">Ziele:</span>
                                        <ul class="list-disc list-inside mt-1 text-sm">
                                            ${ziele.map(ziel => `<li>${ziel}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                
                                ${massnahmen.length > 0 ? `
                                    <div>
                                        <span class="text-gray-600 font-medium">Massnahmen (${massnahmen.length}):</span>
                                        <ul class="list-disc list-inside mt-1 text-sm">
                                            ${massnahmen.slice(0, 3).map(m => {
                                                const mName = m.name || m.beschreibung || 'Massnahme';
                                                const mBudget = m.budgetBrutto || m.budget || 0;
                                                return `<li>${mName} - CHF ${mBudget.toLocaleString('de-CH')}</li>`;
                                            }).join('')}
                                            ${massnahmen.length > 3 ? '<li class="text-gray-500">... und weitere</li>' : ''}
                                        </ul>
                                    </div>
                                ` : ''}
                                
                                ${kpis.length > 0 ? `
                                    <div>
                                        <span class="text-gray-600 font-medium">KPIs (${kpis.length}):</span>
                                        <ul class="list-disc list-inside mt-1 text-sm">
                                            ${kpis.slice(0, 3).map(k => {
                                                const kName = k.name || 'KPI';
                                                const kZielwert = k.zielwert || 0;
                                                const kEinheit = k.einheit || '';
                                                return `<li>${kName}: ${kZielwert} ${kEinheit}</li>`;
                                            }).join('')}
                                            ${kpis.length > 3 ? '<li class="text-gray-500">... und weitere</li>' : ''}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Fehler beim Laden der Teilprojekte:', error);
                container.innerHTML = `
                    <div class="col-span-full text-center py-8 text-red-500">
                        <p>Fehler beim Laden der Teilprojekte</p>
                    </div>
                `;
            }
        }

        async function loadKPIs() {
            const container = document.getElementById('kpisContainer');
            if (!container) return;
            
            try {
                // Lade aktuelle Budget-Daten vom Backend
                const token = localStorage.getItem('authToken');
                const jahrFilter = document.getElementById('jahrFilter')?.value || '2024';
                
                // Lade Budget-KPIs
                const budgetResponse = await fetch(`${API_BASE_URL}/api/budget/kpis?year=${jahrFilter}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                // Lade Rapporte für KPI-Berechnung
                const rapportResponse = await fetch(`${API_BASE_URL}/api/rapporte`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const budgetData = budgetResponse.ok ? await budgetResponse.json() : null;
                const rapportData = rapportResponse.ok ? await rapportResponse.json() : null;
                
                // Berechne echte Budget-Performance pro Teilprojekt
                const budgetByTeilprojekt = budgetData?.budgetByTeilprojekt || {};
                const rapporte = rapportData?.rapports || [];
                
                // Berechne Ausgaben pro Teilprojekt aus Rapporten
                const spentByTeilprojekt = {};
                rapporte.forEach(rapport => {
                    if (rapport.status === 'genehmigt' && rapport.category) {
                        if (!spentByTeilprojekt[rapport.category]) {
                            spentByTeilprojekt[rapport.category] = 0;
                        }
                        try {
                            const content = typeof rapport.content === 'string' ? 
                                JSON.parse(rapport.content) : rapport.content;
                            const amount = parseFloat(content.istBrutto) || parseFloat(content.budgetBrutto) || 0;
                            spentByTeilprojekt[rapport.category] += amount;
                        } catch (e) {
                            console.log('Fehler beim Parsen von Rapport-Content');
                        }
                    }
                });
                
                // Berechne KPI-Metriken
                let totalBudget = 0;
                let totalSpent = 0;
                let projekteUeberBudget = 0;
                let projekteUnterBudget = 0;
                let projekteImZiel = 0;
                
                const teilprojektPerformance = [];
                
                Object.entries(budgetByTeilprojekt).forEach(([key, budget]) => {
                    const spent = spentByTeilprojekt[key] || 0;
                    const percentage = budget > 0 ? (spent / budget) * 100 : 0;
                    
                    totalBudget += budget;
                    totalSpent += spent;
                    
                    // Kategorisiere Performance
                    if (percentage > 110) {
                        projekteUeberBudget++;
                    } else if (percentage < 90 && percentage > 0) {
                        projekteUnterBudget++;
                    } else if (percentage > 0) {
                        projekteImZiel++;
                    }
                    
                    teilprojektPerformance.push({
                        name: formatTeilprojektNameFromKey(key),
                        budget: budget,
                        spent: spent,
                        percentage: percentage
                    });
                });
                
                // Berechne Gesamt-KPI-Erreichung
                const gesamtErreichung = totalBudget > 0 ? 
                    Math.round((totalSpent / totalBudget) * 100) : 0;
                
                // Bestimme Farbe für Gesamt-Erreichung
                const erreichungColor = gesamtErreichung > 100 ? 'text-red-600' : 
                                       gesamtErreichung > 80 ? 'text-green-600' : 
                                       gesamtErreichung > 50 ? 'text-yellow-600' : 
                                       'text-gray-600';
                
                container.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <h3 class="text-lg font-semibold mb-4">Budget-Performance ${jahrFilter}</h3>
                        <div class="space-y-4">
                            ${teilprojektPerformance.length > 0 ? 
                                teilprojektPerformance.map(tp => `
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="font-medium">${tp.name}</span>
                                            <span class="text-gray-600">
                                                ${tp.spent > 0 ? 
                                                    `CHF ${tp.spent.toLocaleString('de-CH')} / ${tp.budget.toLocaleString('de-CH')}` : 
                                                    `CHF ${tp.budget.toLocaleString('de-CH')}`
                                                }
                                            </span>
                                        </div>
                                        <div class="bg-gray-200 rounded-full h-2 overflow-hidden">
                                            <div class="h-full transition-all duration-500 ${
                                                tp.percentage > 100 ? 'bg-red-500' : 
                                                tp.percentage > 80 ? 'bg-yellow-500' : 
                                                'bg-green-500'
                                            }" style="width: ${Math.min(tp.percentage, 100)}%"></div>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1 text-right">
                                            ${tp.percentage.toFixed(1)}% ${tp.percentage > 100 ? '⚠️' : ''}
                                        </div>
                                    </div>
                                `).join('') : 
                                '<p class="text-gray-500 text-center py-4">Keine Budget-Daten verfügbar</p>'
                            }
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <h3 class="text-lg font-semibold mb-4">Projekt-Status Übersicht</h3>
                        <div class="space-y-4">
                            <div class="text-center">
                                <div class="text-3xl font-bold ${erreichungColor} mb-2">
                                    ${gesamtErreichung}%
                                </div>
                                <div class="text-sm text-gray-600">Budget-Auslastung Gesamt</div>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-2 text-center">
                                <div class="p-3 bg-green-50 rounded-lg">
                                    <div class="text-2xl font-bold text-green-600">${projekteImZiel}</div>
                                    <div class="text-xs text-gray-600">Im Ziel</div>
                                    <div class="text-xs text-gray-500">(90-110%)</div>
                                </div>
                                <div class="p-3 bg-yellow-50 rounded-lg">
                                    <div class="text-2xl font-bold text-yellow-600">${projekteUnterBudget}</div>
                                    <div class="text-xs text-gray-600">Unter Budget</div>
                                    <div class="text-xs text-gray-500">(&lt;90%)</div>
                                </div>
                                <div class="p-3 bg-red-50 rounded-lg">
                                    <div class="text-2xl font-bold text-red-600">${projekteUeberBudget}</div>
                                    <div class="text-xs text-gray-600">Über Budget</div>
                                    <div class="text-xs text-gray-500">(&gt;110%)</div>
                                </div>
                            </div>
                            
                            <div class="border-t pt-3">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Gesamtbudget:</span>
                                    <span class="font-semibold">CHF ${totalBudget.toLocaleString('de-CH')}</span>
                                </div>
                                <div class="flex justify-between text-sm mt-1">
                                    <span class="text-gray-600">Ausgegeben:</span>
                                    <span class="font-semibold">CHF ${totalSpent.toLocaleString('de-CH')}</span>
                                </div>
                                <div class="flex justify-between text-sm mt-1">
                                    <span class="text-gray-600">Verbleibend:</span>
                                    <span class="font-semibold ${(totalBudget - totalSpent) < 0 ? 'text-red-600' : 'text-green-600'}">
                                        CHF ${(totalBudget - totalSpent).toLocaleString('de-CH')}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Fehler beim Laden der KPIs:', error);
                container.innerHTML = `
                    <div class="col-span-2 bg-white p-6 rounded-lg shadow-sm border text-center">
                        <p class="text-red-500">Fehler beim Laden der KPI-Daten</p>
                        <p class="text-sm text-gray-500 mt-2">${error.message}</p>
                    </div>
                `;
            }
        }
        
        function formatTeilprojektNameFromKey(key) {
            const nameMap = {
                'tp1-leitmedien': 'TP1 - Leitmedien',
                'tp2-digitale-medien': 'TP2 - Digitale Medien',
                'tp3-messen': 'TP3 - Messen & Ausstellungen',
                'tp4-events': 'TP4 - Events & Aktionen',
                'tp5-schulprojekte': 'TP5 - Schulprojekte',
                'tp6-partnerprojekte': 'TP6 - Partnerprojekte'
            };
            return nameMap[key] || key;
        }

        function formatTeilprojektName(key) {
            const template = teilprojektTemplates[key];
            return template ? template.name : key;
        }

        function formatStatus(status) {
            const statusMap = {
                'entwurf': 'Entwurf',
                'eingereicht': 'Eingereicht',
                'in_bearbeitung': 'In Bearbeitung',
                'fertig': 'Fertig',
                'genehmigt': 'Genehmigt',
                'abgelehnt': 'Abgelehnt'
            };
            return statusMap[status] || status;
        }

        function formatBudgetVarianz(varianz) {
            if (!varianz) return '<span class="text-gray-500">-</span>';
            
            const cssClass = varianz > 10 ? 'variance-negative' : 
                           varianz < -10 ? 'variance-warning' : 
                           'variance-positive';
            
            return `<span class="budget-variance ${cssClass}">
                ${varianz > 0 ? '+' : ''}${varianz}%
            </span>`;
        }

        function getActionButtons(rapport) {
            const buttons = [];
            
            // Ansehen Button für alle
            buttons.push(`<button onclick="viewRapport('${rapport.id}')" class="text-blue-600 hover:text-blue-800 mr-2 text-sm" title="Rapport-Details anzeigen"><i class="fas fa-eye"></i> Ansehen</button>`);
            
            // User-spezifische Buttons
            if (userRole === 'user') {
                // Bearbeiten und Löschen nur für eigene Rapporte im Entwurf-Status
                if (rapport.status === 'entwurf') {
                    buttons.push(`<button onclick="editRapport('${rapport.id}')" class="text-yellow-600 hover:text-yellow-800 mr-2 text-sm" title="Rapport bearbeiten"><i class="fas fa-edit"></i> Bearbeiten</button>`);
                    buttons.push(`<button id="submit-btn-${rapport.id}" onclick="submitRapportToAdmin('${rapport.id}')" class="text-green-600 hover:text-green-800 mr-2 text-sm" title="An Admin senden"><i class="fas fa-paper-plane"></i> Einreichen</button>`);
                    buttons.push(`<button onclick="deleteRapport('${rapport.id}')" class="text-red-600 hover:text-red-800 mr-2 text-sm" title="Rapport löschen"><i class="fas fa-trash"></i> Löschen</button>`);
                }
                // Eingereichte Rapporte können nicht mehr bearbeitet werden
                if (rapport.status === 'eingereicht') {
                    buttons.push(`<span class="text-gray-500 text-sm"><i class="fas fa-clock"></i> Wartet auf Prüfung</span>`);
                }
                if (rapport.status === 'abgelehnt') {
                    buttons.push(`<button onclick="editRapport('${rapport.id}')" class="text-yellow-600 hover:text-yellow-800 mr-2 text-sm" title="Rapport überarbeiten"><i class="fas fa-redo"></i> Überarbeiten</button>`);
                    buttons.push(`<button onclick="deleteRapport('${rapport.id}')" class="text-red-600 hover:text-red-800 mr-2 text-sm" title="Rapport löschen"><i class="fas fa-trash"></i> Löschen</button>`);
                }
                if (rapport.status === 'bestätigt') {
                    buttons.push(`<span class="text-green-600 text-sm"><i class="fas fa-check-circle"></i> Bestätigt</span>`);
                }
            }
            
            // Admin-spezifische Buttons
            if (userRole === 'admin' || userRole === 'super_admin') {
                if (rapport.status === 'eingereicht' || rapport.status === 'in_bearbeitung') {
                    buttons.push(`<button onclick="approveAdminRapport('${rapport.id}')" class="text-green-600 hover:text-green-800 mr-2 text-sm" title="Rapport bestätigen"><i class="fas fa-check"></i> Bestätigen</button>`);
                    buttons.push(`<button onclick="rejectAdminRapport('${rapport.id}')" class="text-red-600 hover:text-red-800 mr-2 text-sm" title="Rapport ablehnen"><i class="fas fa-times"></i> Ablehnen</button>`);
                }
                // Admins können alle Rapporte löschen (mit Vorsicht!)
                buttons.push(`<button onclick="deleteRapport('${rapport.id}')" class="text-red-600 hover:text-red-800 mr-2 text-sm" title="Rapport löschen (Admin)"><i class="fas fa-trash-alt"></i> Löschen</button>`);
            }
            
            // Upload button für alle (ausser abgeschlossene)
            if (rapport.status !== 'abgeschlossen') {
                buttons.push(`<button onclick="showUploadDialog('${rapport.id}')" class="text-gray-600 hover:text-gray-800 mr-2 text-sm" title="Dokumente hinzufügen"><i class="fas fa-paperclip"></i></button>`);
            }
            
            return buttons.join('');
        }

        function showCreateModal() {
            currentRapportId = null;
            document.getElementById('modalTitle').textContent = 'Neuer Rapport';
            document.getElementById('rapportForm').reset();
            document.getElementById('rapportModal').classList.remove('hidden');
            console.log('Modal geöffnet');
        }
        
        // Make modal functions globally available
        window.showCreateModal = showCreateModal;
        
        // Submit rapport form - Vollständige Implementierung
        async function submitRapport(event) {
            event.preventDefault();
            console.log('📝 Rapport wird gespeichert...');
            
            // Sammle alle Formular-Daten
            const teilprojekt = document.getElementById('teilprojektSelect')?.value || '';
            const jahr = document.getElementById('jahrField')?.value || new Date().getFullYear();
            const periode = document.getElementById('periodeField')?.value || '';
            
            // Budget-Daten
            const budgetBrutto = parseFloat(document.getElementById('budgetBruttoField')?.value?.replace(/[^0-9.-]/g, '') || '0');
            const istBrutto = parseFloat(document.getElementById('istBruttoField')?.value?.replace(/[^0-9.-]/g, '') || '0');
            const aufwandsminderung = parseFloat(document.getElementById('aufwandsminderungField')?.value?.replace(/[^0-9.-]/g, '') || '0');
            
            // Text-Felder
            const wasLiefGut = document.getElementById('wasLiefGutField')?.value || '';
            const abweichungen = document.getElementById('abweichungenField')?.value || '';
            const lessonsLearned = document.getElementById('lessonsLearnedField')?.value || '';
            
            // Teilprojekt-Details
            const beschreibung = document.getElementById('teilprojektBeschreibungField')?.value || '';
            const ziele = document.getElementById('teilprojektZieleField')?.value || '';
            
            // Erstelle Titel basierend auf Teilprojekt und Periode
            const title = `Rapport ${teilprojekt} ${periode} ${jahr}`;
            
            // Erstelle strukturierten Content als JSON
            const contentData = {
                teilprojekt,
                jahr,
                periode,
                budgetBrutto,
                istBrutto,
                aufwandsminderung,
                wasLiefGut,
                abweichungen,
                lessonsLearned,
                beschreibung,
                ziele
            };
            
            const rapportData = {
                title: title,
                content: JSON.stringify(contentData),
                category: teilprojekt,
                status: 'entwurf',  // Neue Rapporte starten immer als Entwurf
                arbeitszeit: 0,
                abteilung: 'Marketing'  // TODO: Aus User-Profil nehmen
            };
            
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    showNotification('Bitte melden Sie sich an', 'error');
                    return;
                }
                
                const url = currentRapportId 
                    ? `${API_BASE_URL}/api/rapporte/${currentRapportId}`
                    : `${API_BASE_URL}/api/rapporte`;
                    
                const method = currentRapportId ? 'PUT' : 'POST';
                
                console.log('📤 Sende Rapport-Daten:', rapportData);
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(rapportData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(
                        currentRapportId ? 'Rapport erfolgreich aktualisiert' : 'Rapport erfolgreich erstellt',
                        'success'
                    );
                    closeModal();
                    loadRapporte(); // Reload rapport list
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Fehler beim Speichern', 'error');
                }
            } catch (error) {
                console.error('Error saving rapport:', error);
                showNotification('Netzwerkfehler beim Speichern', 'error');
            }
        }
        
        // Save as draft
        async function saveAsDraft() {
            console.log('💾 Als Entwurf speichern...');
            // Rufe handleSubmit direkt auf - Status ist immer 'entwurf'
            const form = document.getElementById('rapportForm');
            const event = new Event('submit', { cancelable: true, bubbles: true });
            form.dispatchEvent(event);
        }
        
        // Submit for review
        async function submitForReview() {
            console.log('📤 Zur Prüfung einreichen...');
            // Ändere Status auf 'eingereicht' und speichere
            const form = document.getElementById('rapportForm');
            
            // Temporär Status ändern für diese Submission
            window.tempSubmitStatus = 'eingereicht';
            
            const event = new Event('submit', { cancelable: true, bubbles: true });
            form.dispatchEvent(event);
        }
        
        // Funktion um bestehenden Rapport an Admin zu submitten
        async function submitRapportToAdmin(rapportId) {
            const confirm = await confirmDialog(
                'Möchten Sie diesen Rapport zur Prüfung an den Admin senden?',
                'Rapport einreichen'
            );
            
            if (!confirm) {
                return;
            }
            
            console.log('📤 Sende Rapport an Admin:', rapportId);
            
            try {
                const token = localStorage.getItem('authToken');
                
                // Verwende die spezielle submit-Route
                const response = await fetch(`${API_BASE_URL}/api/rapporte/${rapportId}/submit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                if (response.ok) {
                    showNotification('Rapport wurde zur Prüfung eingereicht', 'success');
                    
                    // Button ausblenden nach erfolgreichem Einreichen
                    const submitBtn = document.getElementById(`submit-btn-${rapportId}`);
                    if (submitBtn) {
                        submitBtn.style.display = 'none';
                    }
                    
                    // Warte kurz, dann lade Tabelle neu
                    setTimeout(() => {
                        loadRapporte(); // Tabelle neu laden mit aktualisierten Status
                    }, 500);
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Fehler beim Einreichen');
                }
            } catch (error) {
                console.error('❌ Fehler beim Einreichen:', error);
                showNotification(`Fehler: ${error.message}`, 'error');
            }
        }

        async function deleteRapport(rapportId) {
            // Mehrfache Bestätigung für Sicherheit
            const firstConfirm = await confirmDialog(
                '⚠️ Möchten Sie diesen Rapport wirklich löschen?',
                'Rapport löschen'
            );
            
            if (!firstConfirm) {
                return;
            }
            
            // Zweite Bestätigung für zusätzliche Sicherheit
            const secondConfirm = await showDialog({
                title: '⚠️ Letzte Warnung!',
                message: '<strong>Diese Aktion kann NICHT rückgängig gemacht werden!</strong><br><br>Sind Sie WIRKLICH sicher, dass Sie fortfahren möchten?',
                type: 'error',
                buttons: [
                    { text: 'Abbrechen', type: 'cancel', value: false },
                    { text: 'Ja, endgültig löschen', type: 'danger', value: true }
                ]
            });
            
            if (!secondConfirm) {
                return;
            }
            
            console.log('🗑️ Lösche Rapport:', rapportId);
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/rapporte/${rapportId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    showNotification('✅ Rapport wurde erfolgreich gelöscht', 'success');
                    
                    // Entferne die Zeile aus der Tabelle sofort
                    const row = document.querySelector(`tr[data-rapport-id="${rapportId}"]`);
                    if (row) {
                        row.style.opacity = '0.5';
                        row.style.transition = 'opacity 0.5s';
                        setTimeout(() => row.remove(), 500);
                    }
                    
                    // Lade Tabelle nach kurzer Verzögerung neu
                    setTimeout(() => {
                        loadRapporte();
                    }, 600);
                } else {
                    const error = await response.json();
                    
                    // Spezielle Fehlermeldungen
                    if (response.status === 403) {
                        throw new Error('Sie haben keine Berechtigung, diesen Rapport zu löschen');
                    } else if (response.status === 404) {
                        if (error.message && error.message.includes('bereits eingereicht')) {
                            throw new Error('Nur Entwürfe können gelöscht werden. Eingereichte Rapporte sind geschützt.');
                        } else {
                            throw new Error('Rapport nicht gefunden oder bereits eingereicht');
                        }
                    } else {
                        throw new Error(error.message || 'Fehler beim Löschen');
                    }
                }
            } catch (error) {
                console.error('❌ Fehler beim Löschen:', error);
                showNotification(`Fehler: ${error.message}`, 'error');
            }
        }
        
        function closeModal() {
            document.getElementById('rapportModal').classList.add('hidden');
            document.getElementById('rapportForm').reset();
            currentRapportId = null;
            console.log('Modal geschlossen');
        }
        
        // Make closeModal globally available
        window.closeModal = closeModal;
        
        function closeViewModal() {
            const modal = document.getElementById('viewRapportModal');
            if (modal) {
                modal.classList.add('hidden');
            }
            // Also remove any dynamically created modals
            const dynamicModals = document.querySelectorAll('.fixed.inset-0.bg-gray-500');
            dynamicModals.forEach(modal => modal.remove());
            console.log('View Modal geschlossen');
        }
        
        // Make closeViewModal globally available
        window.closeViewModal = closeViewModal;

        function switchTab(tabName, buttonElement) {
            console.log('Wechsle zu Tab:', tabName);
            
            // Alle Tabs verstecken
            document.querySelectorAll('[id$="-tab"]').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Alle Tab-Buttons deaktivieren
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Aktiven Tab anzeigen
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            
            // Button aktiv setzen (event.target oder übergebenes Element)
            const activeButton = buttonElement || event.target;
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // Wenn Verwaltungs-Tab: Lade Admin-Rapporte
            if (tabName === 'verwaltung') {
                console.log('Verwaltungs-Tab aktiviert - lade Admin-Rapporte');
                loadAdminRapporte();
            }
            
            // Wenn Teilprojekte-Tab: Lade Teilprojekte
            if (tabName === 'teilprojekte') {
                console.log('Teilprojekte-Tab aktiviert - lade Teilprojekte');
                loadTeilprojekte();
            }
            
            // Wenn KPIs-Tab: Lade KPIs
            if (tabName === 'kpis') {
                console.log('KPIs-Tab aktiviert - lade KPIs');
                loadKPIs();
            }
            
            // Wenn Anforderungen-Tab: Lade Anforderungen
            if (tabName === 'anforderungen') {
                console.log('Anforderungen-Tab aktiviert - lade Anforderungen');
                loadAnforderungen();
            }
        }

        function filterRapporte() {
            // Filter werden beim Laden der Rapporte angewendet
            loadRapporte();
            // KPIs auch neu laden mit den aktuellen Filtern
            loadKPIDashboard();
        }

        // Funktion zum Laden der Admin-Rapporte
        async function loadAdminRapporte() {
            console.log('📊 Lade Admin-Rapporte...');
            const token = localStorage.getItem('authToken');
            const reportTableBody = document.getElementById('reportTableBody');
            
            // Prüfe ob Element existiert
            if (!reportTableBody) {
                console.warn('reportTableBody nicht gefunden - Tab vermutlich nicht sichtbar');
                return;
            }
            
            // Zeige Ladeindikator
            reportTableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                        <div class="flex items-center justify-center">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Reports werden geladen...
                        </div>
                    </td>
                </tr>
            `;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/rapporte`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Admin-Rapporte Response:', data);
                console.log('Anzahl Rapporte:', data.rapporte ? data.rapporte.length : 0);
                
                // Prüfe verschiedene Response-Formate
                const rapporte = data.rapporte || data.rapports || [];
                
                if (data.success && rapporte.length > 0) {
                    console.log('✅ Zeige', rapporte.length, 'Rapporte');
                    displayAdminRapporte(rapporte);
                    updateAdminStatistics(rapporte);
                } else {
                    console.log('⚠️ Keine Rapporte gefunden');
                    reportTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                                Keine Rapporte vorhanden
                            </td>
                        </tr>
                    `;
                    // Setze Statistiken auf 0
                    updateAdminStatistics([]);
                }
            } catch (error) {
                console.error('❌ Fehler beim Laden der Admin-Rapporte:', error);
                reportTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-4 text-center text-red-500">
                            Fehler beim Laden der Rapporte: ${error.message}
                        </td>
                    </tr>
                `;
                showNotification('Fehler beim Laden der Rapporte', 'error');
            }
        }
        
        // Funktion zum Anzeigen der Admin-Rapporte
        function displayAdminRapporte(rapporte) {
            console.log('📝 displayAdminRapporte aufgerufen mit', rapporte.length, 'Rapporten');
            const reportTableBody = document.getElementById('reportTableBody');
            
            if (!reportTableBody) {
                console.error('reportTableBody nicht gefunden!');
                return;
            }
            
            // Debug: Zeige ersten Rapport
            if (rapporte.length > 0) {
                console.log('Beispiel Rapport:', rapporte[0]);
            }
            
            reportTableBody.innerHTML = rapporte.map(rapport => {
                const statusClass = getStatusClass(rapport.status);
                const statusText = getStatusText(rapport.status);
                const fortschritt = calculateProgress(rapport);
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <input type="checkbox" class="report-checkbox rounded border-gray-300" data-id="${rapport.id}" onchange="updateBulkActionVisibility()">
                        </td>
                        <td class="px-6 py-4">
                            <div>
                                <p class="font-medium text-gray-900">R-${String(rapport.id).padStart(4, '0')}</p>
                                <p class="text-sm text-gray-500">${rapport.title || rapport.titel || 'Ohne Titel'}</p>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div>
                                <p class="text-sm font-medium text-gray-900">${rapport.author_name || 'Unbekannt'}</p>
                                <p class="text-xs text-gray-500">${rapport.author_email || ''}</p>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div>
                                <p class="text-sm text-gray-900">${rapport.datum ? new Date(rapport.datum).toLocaleDateString('de-CH') : 'Kein Datum'}</p>
                                <p class="text-xs text-gray-500">${rapport.created_at ? new Date(rapport.created_at).toLocaleTimeString('de-CH', {hour: '2-digit', minute: '2-digit'}) : ''}</p>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 ${statusClass} rounded-full text-xs font-medium">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                            ${rapport.budget ? `CHF ${parseInt(rapport.budget).toLocaleString('de-CH')}` : '-'}
                        </td>
                        <td class="px-6 py-4">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: ${fortschritt}%"></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">${fortschritt}%</p>
                        </td>
                        <td class="px-6 py-4">
                            <div class="relative">
                                <button onclick="toggleActionMenu(${rapport.id})" 
                                        class="text-gray-600 hover:text-gray-900 p-1 rounded hover:bg-gray-100">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                                    </svg>
                                </button>
                                <!-- Dropdown Menü -->
                                <div id="action-menu-${rapport.id}" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-50 hidden">
                                    <div class="py-1">
                                        <button onclick="viewAdminRapportWithActions(${rapport.id})" 
                                                class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                            <i class="fas fa-eye mr-2"></i>Ansehen & Prüfen
                                        </button>
                                        ${(rapport.status === 'eingereicht' || rapport.status === 'entwurf' || rapport.status === 'in_bearbeitung') ? `
                                        <button onclick="showQuickApprove(${rapport.id})" 
                                                class="block w-full text-left px-4 py-2 text-sm text-green-700 hover:bg-green-50">
                                            <i class="fas fa-check mr-2"></i>Schnell bestätigen
                                        </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Hilfsfunktionen für Status
        function getStatusClass(status) {
            const classes = {
                'entwurf': 'bg-gray-100 text-gray-800',
                'eingereicht': 'bg-yellow-100 text-yellow-800',
                'in_bearbeitung': 'bg-blue-100 text-blue-800',
                'bestätigt': 'bg-green-100 text-green-800',
                'abgelehnt': 'bg-red-100 text-red-800',
                'abgeschlossen': 'bg-purple-100 text-purple-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }
        
        function getStatusText(status) {
            const texts = {
                'entwurf': 'Entwurf',
                'eingereicht': 'Eingereicht',
                'in_bearbeitung': 'In Bearbeitung',
                'bestätigt': 'Bestätigt',
                'abgelehnt': 'Abgelehnt',
                'abgeschlossen': 'Abgeschlossen'
            };
            return texts[status] || status;
        }
        
        function calculateProgress(rapport) {
            // Berechne Fortschritt basierend auf Status
            const progressMap = {
                'entwurf': 25,
                'eingereicht': 50,
                'in_bearbeitung': 65,
                'bestätigt': 85,
                'abgeschlossen': 100,
                'abgelehnt': 0
            };
            return progressMap[rapport.status] || 0;
        }
        
        // Statistiken aktualisieren
        function updateAdminStatistics(rapporte) {
            const totalReports = rapporte.length;
            const pendingReports = rapporte.filter(r => r.status === 'eingereicht' || r.status === 'in_bearbeitung').length;
            const approvedReports = rapporte.filter(r => r.status === 'bestätigt').length;
            const completedReports = rapporte.filter(r => r.status === 'abgeschlossen').length;
            
            document.getElementById('totalReports').textContent = totalReports;
            document.getElementById('pendingReports').textContent = pendingReports;
            document.getElementById('approvedReports').textContent = approvedReports;
            document.getElementById('completedReports').textContent = completedReports;
        }
        
        // Admin-Funktionen für Rapport-Verwaltung
        async function approveAdminRapport(id) {
            const confirmed = await confirmDialog('Möchten Sie diesen Rapport bestätigen?', 'Rapport bestätigen');
            if (!confirmed) return;
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/rapporte/${id}/approve`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'approve' })
                });
                
                if (response.ok) {
                    showNotification('Rapport wurde bestätigt', 'success');
                    loadAdminRapporte(); // Neu laden
                } else {
                    throw new Error('Fehler beim Bestätigen');
                }
            } catch (error) {
                console.error('Fehler:', error);
                showNotification('Fehler beim Bestätigen des Rapports', 'error');
            }
        }
        
        async function rejectAdminRapport(id) {
            const reason = await promptDialog('Bitte geben Sie einen Grund für die Ablehnung an:', '', 'Rapport ablehnen');
            if (!reason) return;
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/rapporte/${id}/approve`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        action: 'reject',
                        rejection_reason: reason 
                    })
                });
                
                if (response.ok) {
                    showNotification('Rapport wurde abgelehnt', 'info');
                    loadAdminRapporte(); // Neu laden
                } else {
                    throw new Error('Fehler beim Ablehnen');
                }
            } catch (error) {
                console.error('Fehler:', error);
                showNotification('Fehler beim Ablehnen des Rapports', 'error');
            }
        }
        
        // Dropdown-Menü toggle
        function toggleActionMenu(id) {
            const menu = document.getElementById(`action-menu-${id}`);
            
            // Schliesse alle anderen Menüs
            document.querySelectorAll('[id^="action-menu-"]').forEach(m => {
                if (m.id !== `action-menu-${id}`) {
                    m.classList.add('hidden');
                }
            });
            
            // Toggle aktuelles Menü
            menu.classList.toggle('hidden');
            
            // Schliesse Menü bei Klick ausserhalb
            document.addEventListener('click', function closeMenu(e) {
                if (!e.target.closest(`#action-menu-${id}`) && !e.target.closest('[onclick^="toggleActionMenu"]')) {
                    menu.classList.add('hidden');
                    document.removeEventListener('click', closeMenu);
                }
            });
        }
        
        // Erweiterte Ansicht mit Aktionen
        async function viewAdminRapportWithActions(id) {
            // Schliesse Dropdown
            document.querySelectorAll('[id^="action-menu-"]').forEach(m => m.classList.add('hidden'));
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/rapporte/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) throw new Error('Fehler beim Laden des Rapports');
                
                const result = await response.json();
                const rapport = result.rapport || result;
                
                console.log('📋 Rapport Details:', {
                    id: rapport.id,
                    status: rapport.status,
                    title: rapport.title || rapport.titel,
                    content_raw: rapport.content,
                    beschreibung: rapport.beschreibung,
                    datum: rapport.datum,
                    abteilung: rapport.abteilung
                });
                
                // Parse content - Handle both content and beschreibung fields
                let content = {};
                try {
                    // Priorität: content > beschreibung
                    const rawContent = rapport.content || rapport.beschreibung;
                    
                    if (rawContent) {
                        content = typeof rawContent === 'string' ? JSON.parse(rawContent) : rawContent;
                    }
                    
                    console.log('📊 Parsed Content:', content);
                } catch (e) {
                    console.error('Error parsing content:', e);
                    content = {};
                }
                
                // Fallback-Werte aus Rapport-Hauptfeldern
                if (!content.teilprojekt && rapport.category) {
                    content.teilprojekt = rapport.category;
                }
                if (!content.jahr && rapport.datum) {
                    content.jahr = new Date(rapport.datum).getFullYear().toString();
                }
                
                // Erstelle Admin-Modal mit Aktionen
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b px-6 py-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h2 class="text-2xl font-bold">Rapport R-${String(rapport.id).padStart(4, '0')}</h2>
                                    <p class="text-gray-600">${rapport.title || rapport.titel || 'Ohne Titel'}</p>
                                </div>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <!-- Ersteller-Information -->
                            <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600">Eingereicht von</p>
                                        <p class="font-medium text-gray-900">${rapport.author_name || 'Unbekannt'}</p>
                                        <p class="text-sm text-gray-500">${rapport.author_email || ''}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm text-gray-600">Eingereicht am</p>
                                        <p class="font-medium">${rapport.created_at ? new Date(rapport.created_at).toLocaleDateString('de-CH') : '-'}</p>
                                        <p class="text-sm text-gray-500">${rapport.created_at ? new Date(rapport.created_at).toLocaleTimeString('de-CH', {hour: '2-digit', minute: '2-digit'}) : ''} Uhr</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Status-Anzeige -->
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600">Aktueller Status</p>
                                        <span class="inline-block px-3 py-1 mt-1 ${getStatusClass(rapport.status)} rounded-full text-sm font-medium">
                                            ${getStatusText(rapport.status)}
                                        </span>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm text-gray-600">Rapport-Datum</p>
                                        <p class="font-medium">${rapport.datum ? new Date(rapport.datum).toLocaleDateString('de-CH') : new Date(rapport.created_at).toLocaleDateString('de-CH')}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Rapport-Details -->
                            <div class="space-y-4 mb-6">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-600">Teilprojekt</p>
                                        <p class="font-medium">${content.teilprojekt || rapport.abteilung || 'Nicht zugewiesen'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Periode</p>
                                        <p class="font-medium">${content.periode || 'Q1'} ${content.jahr || new Date().getFullYear()}</p>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-600">Budget (Brutto)</p>
                                        <p class="font-medium">CHF ${parseInt(content.budgetBrutto || 0).toLocaleString('de-CH')}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Ist (Brutto)</p>
                                        <p class="font-medium">CHF ${parseInt(content.istBrutto || 0).toLocaleString('de-CH')}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Aufwandsminderung</p>
                                        <p class="font-medium">CHF ${parseInt(content.aufwandsminderung || 0).toLocaleString('de-CH')}</p>
                                    </div>
                                </div>
                                
                                ${content.wasLiefGut ? `
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">Was lief gut?</p>
                                    <div class="p-3 bg-green-50 rounded">${content.wasLiefGut}</div>
                                </div>
                                ` : ''}
                                
                                ${content.abweichungen ? `
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">Abweichungen</p>
                                    <div class="p-3 bg-yellow-50 rounded">${content.abweichungen}</div>
                                </div>
                                ` : ''}
                                
                                ${content.lessonsLearned ? `
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">Lessons Learned</p>
                                    <div class="p-3 bg-blue-50 rounded">${content.lessonsLearned}</div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- Admin-Aktionen -->
                            ${(rapport.status !== 'bestätigt' && rapport.status !== 'abgelehnt' && rapport.status !== 'abgeschlossen') ? `
                            <div class="border-t pt-6">
                                <h3 class="text-lg font-semibold mb-4">Admin-Aktionen</h3>
                                
                                <!-- Kommentarfeld -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Kommentar (optional bei Bestätigung, erforderlich bei Ablehnung)
                                    </label>
                                    <textarea id="admin-comment-${rapport.id}" 
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                              rows="3" 
                                              placeholder="Geben Sie hier Ihren Kommentar oder Feedback ein..."></textarea>
                                </div>
                                
                                <!-- Aktions-Buttons -->
                                <div class="flex gap-4">
                                    <button onclick="approveRapportFromModal(${rapport.id})" 
                                            class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-medium">
                                        <i class="fas fa-check mr-2"></i>Rapport bestätigen
                                    </button>
                                    <button onclick="rejectRapportFromModal(${rapport.id})" 
                                            class="flex-1 bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors font-medium">
                                        <i class="fas fa-times mr-2"></i>Rapport ablehnen
                                    </button>
                                </div>
                                
                                <p class="text-sm text-gray-500 mt-2">* Bei Ablehnung muss ein Kommentar angegeben werden</p>
                            </div>
                            ` : `
                            <div class="border-t pt-6">
                                <p class="text-center text-gray-500">Dieser Rapport wurde bereits bearbeitet.</p>
                            </div>
                            `}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Fehler beim Laden des Rapports:', error);
                showNotification('Fehler beim Laden des Rapports', 'error');
            }
        }
        
        // Bestätigung aus Modal
        async function approveRapportFromModal(id) {
            const comment = document.getElementById(`admin-comment-${id}`)?.value || '';
            
            const confirmed = await confirmDialog('Möchten Sie diesen Rapport wirklich bestätigen?', 'Rapport bestätigen');
            if (!confirmed) return;
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/rapporte/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        status: 'bestätigt',
                        adminKommentar: comment
                    })
                });
                
                if (response.ok) {
                    showNotification('Rapport wurde bestätigt', 'success');
                    document.querySelector('.fixed').remove(); // Schliesse Modal
                    loadAdminRapporte(); // Neu laden
                } else {
                    throw new Error('Fehler beim Bestätigen');
                }
            } catch (error) {
                console.error('Fehler:', error);
                showNotification('Fehler beim Bestätigen des Rapports', 'error');
            }
        }
        
        // Ablehnung aus Modal
        async function rejectRapportFromModal(id) {
            const comment = document.getElementById(`admin-comment-${id}`)?.value || '';
            
            if (!comment.trim()) {
                showNotification('Bitte geben Sie einen Grund für die Ablehnung an', 'warning');
                return;
            }
            
            const confirmed = await confirmDialog('Möchten Sie diesen Rapport wirklich ablehnen?', 'Rapport ablehnen');
            if (!confirmed) return;
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/rapporte/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        status: 'abgelehnt',
                        ablehnungsgrund: comment
                    })
                });
                
                if (response.ok) {
                    showNotification('Rapport wurde abgelehnt', 'info');
                    document.querySelector('.fixed').remove(); // Schliesse Modal
                    loadAdminRapporte(); // Neu laden
                } else {
                    throw new Error('Fehler beim Ablehnen');
                }
            } catch (error) {
                console.error('Fehler:', error);
                showNotification('Fehler beim Ablehnen des Rapports', 'error');
            }
        }
        
        // Schnelle Bestätigung (mit Sicherheitsabfrage)
        async function showQuickApprove(id) {
            // Schliesse Dropdown
            document.querySelectorAll('[id^="action-menu-"]').forEach(m => m.classList.add('hidden'));
            
            const confirmed = await confirmDialog('Möchten Sie diesen Rapport ohne Kommentar bestätigen?', 'Rapport bestätigen');
            if (!confirmed) return;
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/rapporte/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'bestätigt' })
                });
                
                if (response.ok) {
                    showNotification('Rapport wurde bestätigt', 'success');
                    loadAdminRapporte();
                } else {
                    throw new Error('Fehler beim Bestätigen');
                }
            } catch (error) {
                console.error('Fehler:', error);
                showNotification('Fehler beim Bestätigen', 'error');
            }
        }
        
        function viewAdminRapport(id) {
            // Alte Funktion - leitet zur neuen weiter
            viewAdminRapportWithActions(id);
        }
        
        // Bulk-Aktionen für Admin
        function toggleSelectAllReports() {
            const selectAll = document.getElementById('selectAllReports');
            const checkboxes = document.querySelectorAll('.report-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateBulkActionVisibility();
        }
        
        function updateBulkActionVisibility() {
            const checkedBoxes = document.querySelectorAll('.report-checkbox:checked');
            const bulkActions = document.getElementById('bulkReportActions');
            const selectedCount = document.getElementById('selectedReportCount');
            
            if (checkedBoxes.length > 0) {
                bulkActions.classList.remove('hidden');
                selectedCount.textContent = checkedBoxes.length;
            } else {
                bulkActions.classList.add('hidden');
            }
        }
        
        async function bulkApproveReports() {
            const checkedBoxes = document.querySelectorAll('.report-checkbox:checked');
            const ids = Array.from(checkedBoxes).map(cb => cb.dataset.id);
            
            if (ids.length === 0) {
                showNotification('Bitte wählen Sie mindestens einen Rapport aus', 'warning');
                return;
            }
            
            const confirmed = await confirmDialog(`Möchten Sie ${ids.length} Rapport(e) bestätigen?`, 'Mehrere Rapporte bestätigen');
            if (!confirmed) return;
            
            try {
                const token = localStorage.getItem('authToken');
                
                // Process each rapport
                for (const id of ids) {
                    await fetch(`${API_BASE_URL}/api/rapporte/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status: 'bestätigt' })
                    });
                }
                
                showNotification(`${ids.length} Rapport(e) wurden bestätigt`, 'success');
                loadAdminRapporte();
                document.getElementById('selectAllReports').checked = false;
                updateBulkActionVisibility();
            } catch (error) {
                console.error('Fehler bei Bulk-Bestätigung:', error);
                showNotification('Fehler bei der Bulk-Bestätigung', 'error');
            }
        }
        
        async function bulkRejectReports() {
            const checkedBoxes = document.querySelectorAll('.report-checkbox:checked');
            const ids = Array.from(checkedBoxes).map(cb => cb.dataset.id);
            
            if (ids.length === 0) {
                showNotification('Bitte wählen Sie mindestens einen Rapport aus', 'warning');
                return;
            }
            
            const reason = await promptDialog(`Bitte geben Sie einen Grund für die Ablehnung von ${ids.length} Rapport(en) an:`, '', 'Mehrere Rapporte ablehnen');
            if (!reason) return;
            
            try {
                const token = localStorage.getItem('authToken');
                
                // Process each rapport
                for (const id of ids) {
                    await fetch(`${API_BASE_URL}/api/rapporte/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            status: 'abgelehnt',
                            ablehnungsgrund: reason 
                        })
                    });
                }
                
                showNotification(`${ids.length} Rapport(e) wurden abgelehnt`, 'info');
                loadAdminRapporte();
                document.getElementById('selectAllReports').checked = false;
                updateBulkActionVisibility();
            } catch (error) {
                console.error('Fehler bei Bulk-Ablehnung:', error);
                showNotification('Fehler bei der Bulk-Ablehnung', 'error');
            }
        }
        
        function exportSelectedReports() {
            const checkedBoxes = document.querySelectorAll('.report-checkbox:checked');
            const ids = Array.from(checkedBoxes).map(cb => cb.dataset.id);
            
            if (ids.length === 0) {
                showNotification('Bitte wählen Sie mindestens einen Rapport aus', 'warning');
                return;
            }
            
            showNotification(`Export von ${ids.length} Rapport(en) wird vorbereitet...`, 'info');
            // TODO: Implement export functionality
        }
        
        function generateFinalReport() {
            showNotification('Gesamtreport-Funktion wird in Phase 2 implementiert', 'info');
            // TODO: Implement report generation
            // Wird alle bestätigten Rapporte in einen Jahresbericht zusammenfassen
        }
        
        function exportToGoogleDocs() {
            showNotification('Google Docs Export wird in Phase 2 implementiert', 'info');
            // TODO: Implement Google Docs export via Webhook
            // Wird Rapporte über n8n Webhook an Google Docs senden
        }
        
        // Info-Modal für detaillierte Erklärungen
        function showInfoModal(type) {
            let title = '';
            let content = '';
            
            if (type === 'gesamtreport') {
                title = 'Gesamtreport erstellen';
                content = `
                    <div class="space-y-3">
                        <p><strong>Was ist ein Gesamtreport?</strong></p>
                        <p>Der Gesamtreport fasst alle bestätigten Einzelrapporte automatisch zu einem umfassenden Jahresbericht zusammen.</p>
                        
                        <p><strong>Inhalt:</strong></p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>Executive Summary mit Gesamtübersicht</li>
                            <li>Konsolidierte Daten aller Teilprojekte</li>
                            <li>Budgetübersicht und Verwendungsnachweis</li>
                            <li>Aggregierte Erfolge und Lessons Learned</li>
                            <li>Grafische Auswertungen und KPIs</li>
                        </ul>
                        
                        <p><strong>Verwendung:</strong></p>
                        <p>Ideal für Jahresabschlüsse, Reporting an Vorstand und Behörden.</p>
                        
                        <p class="text-sm text-gray-500 mt-3">Status: In Entwicklung (Phase 2)</p>
                    </div>
                `;
            } else if (type === 'googledocs') {
                title = 'Dokument Export';
                content = `
                    <div class="space-y-3">
                        <p><strong>Was macht diese Funktion?</strong></p>
                        <p>Erstellt aus Ihren Rapporten ein formatiertes Dokument, das Sie direkt in Google Docs oder Word öffnen und bearbeiten können.</p>
                        
                        <p><strong>Das erhalten Sie:</strong></p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>Ein professionell formatiertes Dokument</li>
                            <li>Alle Ihre Rapportdaten übersichtlich dargestellt</li>
                            <li>Direkt bearbeitbar in Google Docs oder Word</li>
                            <li>Einfach per E-Mail teilbar mit Kollegen</li>
                        </ul>
                        
                        <p><strong>Perfekt für:</strong></p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>Präsentationen für Vorgesetzte</li>
                            <li>Archivierung und Dokumentation</li>
                            <li>Weiterbearbeitung mit dem Team</li>
                        </ul>
                        
                        <p class="text-sm text-gray-500 mt-3">Status: In Entwicklung (Phase 2)</p>
                    </div>
                `;
            }
            
            // Erstelle und zeige Modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">${title}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="text-sm text-gray-700">
                        ${content}
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button onclick="this.closest('.fixed').remove()" 
                                class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">
                            Schliessen
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function previewFinalReport() {
            showNotification('Vorschau wird geladen...', 'info');
            // TODO: Implement preview functionality
        }
        
        async function approveRapport(id) {
            showNotification('Genehmigungsfunktion wird implementiert', 'info');
        }
        
        // Upload dialog function is defined later in the code

        async function handleSubmit(event) {
            event.preventDefault();
            console.log('📝 handleSubmit aufgerufen');
            
            // Sammle alle Formular-Daten - KEINE Pflichtfelder!
            const teilprojekt = document.getElementById('teilprojektSelect')?.value || 'Allgemein';
            const jahr = document.querySelector('select[name="jahr"]')?.value || new Date().getFullYear().toString();
            const periode = document.querySelector('select[name="periode"]')?.value || 'Q1';
            
            // Sammle alle Massnahmen KZL Auswahlen
            const massnahmenData = {};
            document.querySelectorAll('select[name^="kZielBezug_"]').forEach(select => {
                const selected = Array.from(select.selectedOptions).map(opt => opt.value);
                if (selected.length > 0) {
                    massnahmenData[select.name] = selected;
                }
            });
            
            // Sammle KPI IST-Werte
            const kpiData = {};
            document.querySelectorAll('input[name^="kpi_"]').forEach(input => {
                if (input.value && !input.name.includes('_name_') && !input.name.includes('_target_')) {
                    kpiData[input.name] = input.value;
                }
            });
            
            // Sammle alle Text-Felder aus den verschiedenen Bereichen
            const textFields = {};
            const fieldNames = [
                'zieleinschaetzung', 'massnahmenDetails', 'zielgruppenErreichung',
                'medienresonanz', 'partnerFeedback', 'weitereEffekte',
                'zusammenfassung', 'abgeschlosseneAktivitaeten', 'laufendeAktivitaeten',
                'geplanteAktivitaeten', 'herausforderungen', 'verbesserungen',
                'empfehlungen', 'ausblick', 'liefGut', 'abweichungen', 'lessonsLearned'
            ];
            
            fieldNames.forEach(name => {
                const field = document.querySelector(`[name="${name}"]`);
                if (field && field.value) {
                    textFields[name] = field.value;
                }
            });
            
            // Hole Teilprojekt-Name für Title
            const teilprojektOption = document.querySelector(`#teilprojektSelect option[value="${teilprojekt}"]`);
            const teilprojektName = teilprojektOption ? teilprojektOption.textContent : teilprojekt;
            
            // Erstelle Titel
            const title = `Rapport ${teilprojektName} - ${periode} ${jahr}`;
            
            // Prepare rapport data - mit allen Feldern
            const contentData = {
                teilprojekt: teilprojektName,
                jahr: jahr,
                periode: periode,
                massnahmen: massnahmenData,
                kpis: kpiData,
                ...textFields  // Füge alle Text-Felder hinzu
            };
            
            const rapportData = {
                title: title,
                content: JSON.stringify(contentData),
                category: teilprojekt || 'Allgemein',
                status: window.tempSubmitStatus || 'entwurf'  // Default: Entwurf, ausser explizit anders
            };
            
            console.log('📤 Sende Rapport-Daten:', rapportData);
            
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    showNotification('Bitte melden Sie sich an', 'error');
                    return;
                }
                
                const url = currentRapportId 
                    ? `${API_BASE_URL}/api/rapporte/${currentRapportId}`
                    : `${API_BASE_URL}/api/rapporte`;
                    
                const method = currentRapportId ? 'PUT' : 'POST';
                
                console.log(`📮 ${method} Request an:`, url);
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(rapportData)
                });
                
                const result = await response.json();
                console.log('📨 Response:', result);
                
                if (response.ok) {
                    // Zeige spezifische Nachricht je nach Status
                    let message = 'Rapport erfolgreich ';
                    if (currentRapportId) {
                        message += 'aktualisiert';
                    } else if (window.tempSubmitStatus === 'eingereicht') {
                        message += 'zur Prüfung eingereicht';
                    } else {
                        message += 'als Entwurf gespeichert';
                    }
                    
                    showNotification(message, 'success');
                    
                    // Reset temporären Status
                    window.tempSubmitStatus = null;
                    
                    closeModal();
                    loadRapporte();
                } else {
                    console.error('❌ Fehler:', result);
                    showNotification(result.message || result.error || 'Fehler beim Speichern', 'error');
                }
            } catch (error) {
                console.error('Error saving rapport:', error);
                showNotification('Netzwerkfehler beim Speichern', 'error');
            }
        }

        async function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            // Validierung
            if (file.type !== 'application/pdf') {
                await alertDialog('Nur PDF-Dateien sind erlaubt.', 'Ungültiger Dateityp', 'error');
                input.value = '';
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) { // 10MB
                await alertDialog('Datei zu gross. Maximale Grösse: 10MB', 'Datei zu groß', 'error');
                input.value = '';
                return;
            }
            
            // UI Update
            document.getElementById('uploadArea').classList.add('hidden');
            document.getElementById('fileInfo').classList.remove('hidden');
            document.getElementById('fileName').textContent = file.name;
            
            console.log('Datei ausgewählt:', file.name, 'Grösse:', (file.size / 1024 / 1024).toFixed(2) + 'MB');
        }

        function removeFile() {
            document.getElementById('rapportDocument').value = '';
            document.getElementById('uploadArea').classList.remove('hidden');
            document.getElementById('fileInfo').classList.add('hidden');
            console.log('Datei entfernt');
        }

        function calculateVariance() {
            const budget = parseFloat(document.querySelector('input[name="budgetBrutto"]').value) || 0;
            const ist = parseFloat(document.querySelector('input[name="istBrutto"]').value) || 0;
            
            // Automatisch Aufwandsminderung berechnen (10% des IST-Werts)
            const aufwandsminderung = ist * 0.1; // 10% Aufwandsminderung
            const aufwandsminderungField = document.querySelector('input[name="aufwandsminderung"]');
            if (aufwandsminderungField) {
                aufwandsminderungField.value = aufwandsminderung.toFixed(2);
            }
            
            if (budget > 0) {
                const varianz = ((ist - budget) / budget * 100).toFixed(1);
                const varianzElement = document.getElementById('budgetVarianz');
                if (varianzElement) {
                    varianzElement.textContent = `${varianz > 0 ? '+' : ''}${varianz}%`;
                    
                    // Farbcodierung
                    if (Math.abs(varianz) > 10) {
                        varianzElement.className = 'text-lg font-bold text-red-600';
                    } else if (Math.abs(varianz) > 5) {
                        varianzElement.className = 'text-lg font-bold text-yellow-600';
                    } else {
                        varianzElement.className = 'text-lg font-bold text-green-600';
                    }
                }
            }
            
            calculateNetto();
        }

        function calculateNetto() {
            const istBrutto = parseFloat(document.querySelector('input[name="istBrutto"]').value) || 0;
            const minderung = parseFloat(document.querySelector('input[name="aufwandsminderung"]').value) || 0;
            const netto = istBrutto - minderung;
            
            document.getElementById('kostenNetto').textContent = `CHF ${netto.toLocaleString('de-CH')}`;
        }
        
        // Berechne Netto-Kosten für einzelne Massnahmen
        function calculateMassnahmeNetto(nr) {
            const istBruttoField = document.querySelector(`input[name="istBrutto_${nr}"]`);
            const aufwandsminderungField = document.querySelector(`input[name="aufwandsminderung_${nr}"]`);
            const kostenNettoField = document.getElementById(`kostenNetto_${nr}`);
            
            if (istBruttoField && aufwandsminderungField && kostenNettoField) {
                const istBrutto = parseFloat(istBruttoField.value) || 0;
                
                // Automatisch 10% Aufwandsminderung berechnen
                const aufwandsminderung = istBrutto * 0.1;
                aufwandsminderungField.value = aufwandsminderung.toFixed(2);
                
                // Netto berechnen
                const netto = istBrutto - aufwandsminderung;
                kostenNettoField.value = `CHF ${netto.toLocaleString('de-CH')}`;
            }
            
            // Update Totals
            calculateMassnahmenTotals();
        }
        
        // Berechne Totale für alle Massnahmen
        function calculateMassnahmenTotals() {
            let totalIst = 0;
            let totalMinderung = 0;
            let totalNetto = 0;
            let totalStreu = 0;
            let totalProd = 0;
            let totalOverhead = 0;
            
            // Finde alle Massnahmen-Zeilen
            for (let i = 1; i <= 10; i++) { // Max 10 Massnahmen angenommen
                const istField = document.querySelector(`input[name="istBrutto_${i}"]`);
                if (istField) {
                    totalIst += parseFloat(istField.value) || 0;
                    
                    const minderungField = document.querySelector(`input[name="aufwandsminderung_${i}"]`);
                    totalMinderung += parseFloat(minderungField?.value) || 0;
                    
                    const streuField = document.querySelector(`input[name="streukosten_${i}"]`);
                    totalStreu += parseFloat(streuField?.value) || 0;
                    
                    const prodField = document.querySelector(`input[name="produktionskosten_${i}"]`);
                    totalProd += parseFloat(prodField?.value) || 0;
                    
                    const overheadField = document.querySelector(`input[name="overhead_${i}"]`);
                    totalOverhead += parseFloat(overheadField?.value) || 0;
                }
            }
            
            totalNetto = totalIst - totalMinderung;
            
            // Update Total-Felder
            const totalIstField = document.getElementById('totalIstBrutto');
            if (totalIstField) totalIstField.value = `CHF ${totalIst.toLocaleString('de-CH')}`;
            
            const totalMinderungField = document.getElementById('totalAufwandsminderung');
            if (totalMinderungField) totalMinderungField.value = `CHF ${totalMinderung.toLocaleString('de-CH')}`;
            
            const totalNettoField = document.getElementById('totalKostenNetto');
            if (totalNettoField) totalNettoField.value = `CHF ${totalNetto.toLocaleString('de-CH')}`;
            
            const totalStreuField = document.getElementById('totalStreukosten');
            if (totalStreuField) totalStreuField.value = `CHF ${totalStreu.toLocaleString('de-CH')}`;
            
            const totalProdField = document.getElementById('totalProduktionskosten');
            if (totalProdField) totalProdField.value = `CHF ${totalProd.toLocaleString('de-CH')}`;
            
            const totalOverheadField = document.getElementById('totalOverhead');
            if (totalOverheadField) totalOverheadField.value = `CHF ${totalOverhead.toLocaleString('de-CH')}`;
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 
                          type === 'error' ? 'bg-red-500' : 
                          type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';
            
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('animate-fade-out');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Logout function
        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = '../login.html';
        }

        // Build navigation menu based on user role
        function buildNavigation(userRole) {
            const navigationItems = {
                'user': [
                    { id: 'dashboard', label: 'Dashboard', icon: '<path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path>', href: '../index.html', active: false },
                    { id: 'rapport', label: 'Rapport', icon: '<path d="M9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4zm2 2H5V5h14v14H19zm0-16H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"></path>', href: 'rapport.html', active: true }
                ],
                'admin': [
                    { id: 'dashboard', label: 'Dashboard', icon: '<path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path>', href: '../index.html', active: false },
                    { id: 'rapport', label: 'Rapport', icon: '<path d="M9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4zm2 2H5V5h14v14H19zm0-16H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"></path>', href: 'rapport.html', active: true },
                    { id: 'archiv', label: 'Archiv', icon: '<path d="M3,3H21V7H3V3M4,8H20V21H4V8M9.5,11A0.5,0.5 0 0,0 9,11.5V13H15V11.5A0.5,0.5 0 0,0 14.5,11H9.5Z"/>', href: 'archiv.html', active: false },
                    { id: 'einstellungen', label: 'Einstellungen', icon: '<path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>', href: 'einstellungen.html', active: false }
                ],
                'super_admin': [
                    { id: 'dashboard', label: 'Dashboard', icon: '<path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path>', href: '../index.html', active: false },
                    { id: 'rapport', label: 'Rapport', icon: '<path d="M9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4zm2 2H5V5h14v14H19zm0-16H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"></path>', href: 'rapport.html', active: true },
                    { id: 'archiv', label: 'Archiv', icon: '<path d="M3,3H21V7H3V3M4,8H20V21H4V8M9.5,11A0.5,0.5 0 0,0 9,11.5V13H15V11.5A0.5,0.5 0 0,0 14.5,11H9.5Z"/>', href: 'archiv.html', active: false },
                    { id: 'einstellungen', label: 'Einstellungen', icon: '<path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>', href: 'einstellungen.html', active: false }
                ]
            };

            const items = navigationItems[userRole] || navigationItems['user'];
            const navMenu = document.getElementById('nav-menu');
            
            navMenu.innerHTML = items.map(item => {
                const activeClass = item.active ? 'nav-link nav-link-active' : 'flex items-center gap-3 px-4 py-2.5 rounded-full text-[var(--color-text-secondary)] hover:bg-gray-100 font-medium transition-colors';
                
                return `
                    <a class="${activeClass}" href="${item.href}">
                        <svg fill="currentColor" height="24px" viewBox="0 0 24 24" width="24px" xmlns="http://www.w3.org/2000/svg">
                            ${item.icon}
                        </svg>
                        <span>${item.label}</span>
                    </a>
                `;
            }).join('');
        }

        // Load user info for sidebar
        async function loadUserInfo() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/users/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const userResponse = await response.json();
                    const user = userResponse.user;
                    
                    // Display user name
                    let displayName = 'Benutzer';
                    if (user.first_name && user.last_name) {
                        displayName = `${user.first_name} ${user.last_name}`;
                    } else if (user.name) {
                        displayName = user.name;
                    }
                    
                    document.getElementById('user-name').textContent = displayName;
                    
                    // Set role display
                    const roleDisplayMap = {
                        'super_admin': 'Super Administrator',
                        'admin': 'Administrator', 
                        'user': 'Nutzer'
                    };
                    
                    userRole = user.role || 'user'; // Update global variable
                    document.getElementById('user-role').textContent = roleDisplayMap[userRole] || 'Nutzer';
                    
                    // Build navigation menu based on user role
                    buildNavigation(userRole);
                    
                    // Show/hide Report-Verwaltung tab based on role
                    const verwaltungButton = document.getElementById('verwaltung-button');
                    if (verwaltungButton) {
                        if (userRole === 'admin' || userRole === 'super_admin') {
                            verwaltungButton.style.display = 'block';
                        } else {
                            verwaltungButton.style.display = 'none';
                        }
                    }
                } else {
                    localStorage.removeItem('authToken');
                    window.location.href = '../login.html';
                }
            } catch (error) {
                console.error('Error loading user info:', error);
                localStorage.removeItem('authToken');
                window.location.href = '../login.html';
            }
        }

        // Load rapports from backend
        async function loadRapporte() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    window.location.href = '../login.html';
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/api/rapporte`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '../login.html';
                    return;
                }
                
                if (!response.ok) {
                    console.error('Error loading rapports:', response.status);
                    showNotification('Fehler beim Laden der Rapporte', 'error');
                    return;
                }
                
                const result = await response.json();
                // Handle both formats: array or object with rows
                let rapporte = result.rapports || [];
                if (rapporte.rows) {
                    rapporte = rapporte.rows;
                }
                
                console.log('📋 Rapporte geladen:', rapporte.length, 'Einträge', rapporte);
                
                // Apply filters
                const jahrFilter = document.getElementById('jahrFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                const teilprojektFilter = document.getElementById('teilprojektFilter').value;
                
                const filteredRapporte = rapporte.filter(rapport => {
                    // Map SQLite field names to expected field names
                    if (rapport.titel && !rapport.title) rapport.title = rapport.titel;
                    if (rapport.beschreibung && !rapport.content) rapport.content = rapport.beschreibung;
                    
                    // Parse content if it's JSON
                    let parsedContent = {};
                    try {
                        parsedContent = typeof rapport.content === 'string' ? JSON.parse(rapport.content) : rapport.content;
                    } catch (e) {
                        console.error('Error parsing rapport content:', e);
                    }
                    
                    // Apply filters
                    // Jahr-Filter: Prüfe das Datum des Rapports
                    if (jahrFilter) {
                        const rapportYear = rapport.datum ? new Date(rapport.datum).getFullYear().toString() : 
                                          rapport.created_at ? new Date(rapport.created_at).getFullYear().toString() : '';
                        if (rapportYear !== jahrFilter) return false;
                    }
                    if (statusFilter && rapport.status !== statusFilter) return false;
                    if (teilprojektFilter && rapport.category !== teilprojektFilter) return false;
                    
                    return true;
                });
                
                console.log('📋 Nach Filter:', filteredRapporte.length, 'Rapporte angezeigt');
                
                // Update UI
                displayRapporte(filteredRapporte);
                updateKPIDashboard(rapporte);
                
            } catch (error) {
                console.error('Error loading rapporte:', error);
                showNotification('Netzwerkfehler beim Laden der Rapporte', 'error');
            }
        }
        
        // Display rapports in table
        function displayRapporte(rapporte) {
            console.log('📝 displayRapporte aufgerufen mit', rapporte.length, 'Rapporten');
            const tbody = document.getElementById('rapportTableBody');
            if (!tbody) {
                console.error('Rapport table body not found');
                return;
            }
            
            console.log('📝 tbody gefunden:', tbody);
            
            if (rapporte.length === 0) {
                console.log('📝 Keine Rapporte - zeige leere Nachricht');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4 text-gray-500">
                            Keine Rapporte gefunden
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = rapporte.map(rapport => {
                // Map SQLite field names to expected field names
                if (rapport.titel && !rapport.title) rapport.title = rapport.titel;
                if (rapport.beschreibung && !rapport.content) rapport.content = rapport.beschreibung;
                
                let parsedContent = {};
                try {
                    parsedContent = typeof rapport.content === 'string' ? JSON.parse(rapport.content) : rapport.content;
                } catch (e) {
                    console.error('Error parsing rapport content:', e);
                }
                
                const statusClass = `status-${rapport.status || 'entwurf'}`;
                const budget = parsedContent.budgetBrutto || 0;
                const actual = parsedContent.istBrutto || 0;
                const variance = budget > 0 ? ((actual - budget) / budget * 100).toFixed(1) : 0;
                
                return `
                    <tr data-rapport-id="${rapport.id}">
                        <td class="px-4 py-3">${rapport.id}</td>
                        <td class="px-4 py-3">${parsedContent.teilprojekt || rapport.category || '-'}</td>
                        <td class="px-4 py-3">${parsedContent.periode || '-'}</td>
                        <td class="px-4 py-3">
                            <span class="status-badge ${statusClass}">
                                ${formatStatus(rapport.status)}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-right">CHF ${Number(budget).toLocaleString('de-CH')}</td>
                        <td class="px-4 py-3 text-right">CHF ${Number(actual).toLocaleString('de-CH')}</td>
                        <td class="px-4 py-3 text-center">${formatBudgetVarianz(variance)}</td>
                        <td class="px-4 py-3 text-center">
                            ${getActionButtons(rapport)}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Helper function to parse rapport content
        function parseRapportContent(rapport) {
            let content = {};
            try {
                const contentField = rapport.content || rapport.beschreibung || '{}';
                if (typeof contentField === 'string') {
                    if (contentField.startsWith('{')) {
                        content = JSON.parse(contentField);
                    } else {
                        content = { text: contentField };
                    }
                } else if (typeof contentField === 'object') {
                    content = contentField;
                }
            } catch (e) {
                content = {};
            }
            return content;
        }
        
        // Update KPI Dashboard
        function updateKPIDashboard(rapporte) {
            console.log('📊 Updating KPI Dashboard with', rapporte.length, 'rapports');
            
            // Budget aus den tatsächlichen Rapporten berechnen
            // Kein hardcoded Budget mehr!
            let totalBudget = 0;
            
            let totalSpent = 0;
            let activeCount = 0;
            let statusCounts = {
                'entwurf': 0,
                'eingereicht': 0,
                'zur-pruefung': 0,
                'genehmigt': 0,
                'abgelehnt': 0
            };
            
            rapporte.forEach(rapport => {
                // Map SQLite field names to expected field names
                if (rapport.titel && !rapport.title) rapport.title = rapport.titel;
                if (rapport.beschreibung && !rapport.content) rapport.content = rapport.beschreibung;
                
                // Count by status
                const status = rapport.status || 'entwurf';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
                
                // Count active rapports (not finished/rejected)
                if (['entwurf', 'eingereicht', 'zur-pruefung'].includes(status)) {
                    activeCount++;
                }
                
                // Parse content for budget data
                const parsedContent = parseRapportContent(rapport);
                
                // Only count spending from approved rapports
                if (status === 'genehmigt' && parsedContent.istBrutto) {
                    totalSpent += Number(parsedContent.istBrutto) || 0;
                }
            });
            
            // Budget aus genehmigten Rapporten berechnen
            rapporte.forEach(rapport => {
                const content = parseRapportContent(rapport);
                if (content.budgetBrutto && rapport.status === 'genehmigt') {
                    totalBudget += Number(content.budgetBrutto) || 0;
                }
            });
            
            // Calculate utilization based on actual data
            const budgetUtilization = totalBudget > 0 ? ((totalSpent / totalBudget) * 100).toFixed(1) : 0;
            const progressPercentage = totalBudget > 0 ? Math.min(100, Math.round((totalSpent / totalBudget) * 100)) : 0;
            
            // Update display with real data
            document.getElementById('totalBudget').textContent = totalBudget > 0 ? `CHF ${totalBudget.toLocaleString('de-CH')}` : 'CHF 0';
            document.getElementById('spentBudget').textContent = `CHF ${totalSpent.toLocaleString('de-CH')}`;
            document.getElementById('budgetUtilization').textContent = `${budgetUtilization}%`;
            document.getElementById('activeReports').textContent = activeCount;
            
            // Update progress bar
            const progressElement = document.getElementById('budgetProgress');
            if (progressElement) {
                progressElement.style.width = `${progressPercentage}%`;
            }
            
            console.log('KPI Update Complete:', {
                totalBudget: totalBudget,
                totalSpent,
                utilization: budgetUtilization,
                activeReports: activeCount,
                statusCounts
            });
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            // Simple notification implementation
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'success' ? 'bg-green-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Upload functionality
        let currentRapportForUpload = null;

        function showUploadDialog(rapportId) {
            currentRapportForUpload = rapportId;
            
            // Create upload modal
            const uploadModal = document.createElement('div');
            uploadModal.id = 'uploadModal';
            uploadModal.className = 'fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50';
            uploadModal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4">
                    <h3 class="text-xl font-semibold mb-4">Datei hochladen</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Datei auswählen (max. 10MB)
                        </label>
                        <input type="file" id="uploadFile" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg" 
                               class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <p class="text-xs text-gray-500 mt-1">
                            Erlaubte Dateitypen: PDF, DOC, DOCX, XLS, XLSX, PNG, JPG, JPEG
                        </p>
                    </div>
                    
                    <div id="uploadProgress" class="hidden mb-4">
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="uploadProgressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">Hochladen...</p>
                    </div>
                    
                    <div id="uploadError" class="hidden mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded"></div>
                    
                    <div class="flex justify-end gap-3">
                        <button onclick="closeUploadDialog()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                            Abbrechen
                        </button>
                        <button onclick="uploadFile()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Hochladen
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(uploadModal);
        }

        function closeUploadDialog() {
            const modal = document.getElementById('uploadModal');
            if (modal) {
                modal.remove();
            }
            currentRapportForUpload = null;
        }

        async function uploadFile() {
            const fileInput = document.getElementById('uploadFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showUploadError('Bitte wählen Sie eine Datei aus.');
                return;
            }
            
            // Show progress
            document.getElementById('uploadProgress').classList.remove('hidden');
            document.getElementById('uploadError').classList.add('hidden');
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/upload/rapport/${currentRapportForUpload}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Upload erfolgreich:', result);
                    
                    // Close modal and refresh documents list
                    closeUploadDialog();
                    loadDocuments(currentRapportForUpload);
                    
                    // Show success message
                    showNotification('Datei erfolgreich hochgeladen', 'success');
                } else {
                    const error = await response.json();
                    showUploadError(error.error || 'Upload fehlgeschlagen');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showUploadError('Netzwerkfehler beim Upload');
            }
        }

        function showUploadError(message) {
            const errorDiv = document.getElementById('uploadError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            document.getElementById('uploadProgress').classList.add('hidden');
        }

        async function loadDocuments(rapportId) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/upload/rapport/${rapportId}/documents`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    displayDocuments(result.documents);
                }
            } catch (error) {
                console.error('Error loading documents:', error);
            }
        }

        function displayDocuments(documents) {
            // This function would update the UI to show the list of documents
            console.log('Documents:', documents);
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        async function downloadDocument(documentId) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/upload/document/${documentId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const contentDisposition = response.headers.get('Content-Disposition');
                    const filename = contentDisposition
                        ? contentDisposition.split('filename=')[1].replace(/"/g, '')
                        : 'download';
                    
                    // Create download link
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                } else {
                    showNotification('Download fehlgeschlagen', 'error');
                }
            } catch (error) {
                console.error('Download error:', error);
                showNotification('Netzwerkfehler beim Download', 'error');
            }
        }
        
        // Check authentication on page load
        async function checkAuth() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '../login.html';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '../login.html';
                    return;
                }
                
                if (!response.ok) {
                    console.error('Auth check failed:', response.status);
                    return;
                }
                
                const data = await response.json();
                if (data.user) {
                    userRole = data.user.role;
                    // Speichere die Rolle im localStorage für zukünftige Verwendung
                    localStorage.setItem('userRole', userRole);
                    console.log('User role set to:', userRole);
                }
            } catch (error) {
                console.error('Auth check error:', error);
            }
        }
        
        // Logout function
        function logout() {
            // Clear authentication token
            localStorage.removeItem('authToken');
            // Clear any other stored data
            localStorage.removeItem('userRole');
            localStorage.removeItem('userName');
            // Force redirect to login page
            window.location.replace('../login.html');
        }
        
        // Budget calculation functions
        function calculateVariance() {
            const budgetBrutto = parseFloat(document.getElementById('budgetBruttoField').value) || 0;
            const istBrutto = parseFloat(document.querySelector('input[name="istBrutto"]').value) || 0;
            
            // Automatisch Aufwandsminderung berechnen (z.B. 10% des IST-Werts)
            const aufwandsminderung = istBrutto * 0.1; // 10% Aufwandsminderung
            document.querySelector('input[name="aufwandsminderung"]').value = aufwandsminderung.toFixed(2);
            
            // Netto berechnen
            calculateNetto();
            
            // Varianz berechnen
            if (budgetBrutto > 0) {
                const varianz = ((istBrutto - budgetBrutto) / budgetBrutto * 100).toFixed(1);
                const varianzElement = document.getElementById('budgetVarianz');
                if (varianzElement) {
                    varianzElement.textContent = varianz + '%';
                    varianzElement.classList.remove('text-green-600', 'text-red-600');
                    varianzElement.classList.add(varianz <= 0 ? 'text-green-600' : 'text-red-600');
                }
            }
        }
        
        function calculateNetto() {
            const istBrutto = parseFloat(document.querySelector('input[name="istBrutto"]').value) || 0;
            const aufwandsminderung = parseFloat(document.querySelector('input[name="aufwandsminderung"]').value) || 0;
            const kostenNetto = istBrutto - aufwandsminderung;
            
            const nettoElement = document.getElementById('kostenNetto');
            if (nettoElement) {
                nettoElement.textContent = 'CHF ' + kostenNetto.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, "'");
            }
        }
        
        // ========== DEADLINE FEATURE FUNCTIONS ==========
        
        // Load angeforderte Rapporte
        async function loadAnforderungen() {
            try {
                const token = localStorage.getItem('authToken');
                const userRole = localStorage.getItem('userRole');
                
                console.log('LoadAnforderungen - User Role:', userRole);
                
                // Show the correct UI based on role IMMEDIATELY
                if (['admin', 'super_admin'].includes(userRole)) {
                    document.getElementById('admin-anforderungen').classList.remove('hidden');
                    document.getElementById('user-anforderungen').classList.add('hidden');
                } else {
                    document.getElementById('user-anforderungen').classList.remove('hidden');
                    document.getElementById('admin-anforderungen').classList.add('hidden');
                }
                
                // Decide which endpoint to use based on role
                const endpoint = ['admin', 'super_admin'].includes(userRole) 
                    ? '/api/rapporte/all-requests'
                    : '/api/rapporte/requested';
                
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('Anforderungen Response Status:', response.status, 'OK:', response.ok);
                
                if (!response.ok) {
                    console.error('Anforderungen API Error:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('Error details:', errorText);
                }
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (['admin', 'super_admin'].includes(userRole)) {
                        displayAdminAnforderungen(data);
                    } else {
                        displayUserAnforderungen(data);
                    }
                    
                    // Update badge
                    const badge = document.getElementById('anforderungen-badge');
                    if (data.pending > 0) {
                        badge.textContent = data.pending;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Fehler beim Laden der Anforderungen:', error);
            }
        }
        
        // Display anforderungen for users
        function displayUserAnforderungen(data) {
            const container = document.getElementById('anforderungen-list');
            
            if (data.requests.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Keine angeforderten Rapporte vorhanden.</p>';
                return;
            }
            
            container.innerHTML = data.requests.map(req => {
                const deadlineDate = new Date(req.deadline);
                const daysRemaining = req.days_remaining || 0;
                let statusClass = 'bg-blue-100 text-blue-800';
                let urgencyIcon = '';
                
                if (req.status === 'überfällig') {
                    statusClass = 'bg-red-100 text-red-800';
                    urgencyIcon = '⚠️ ';
                } else if (req.status === 'dringend') {
                    statusClass = 'bg-yellow-100 text-yellow-800';
                    urgencyIcon = '⏰ ';
                } else if (req.status === 'erfüllt') {
                    statusClass = 'bg-green-100 text-green-800';
                }
                
                return `
                    <div class="border rounded-lg p-4 ${req.status === 'überfällig' ? 'border-red-300 bg-red-50' : 'border-gray-200'}">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-semibold text-lg">${urgencyIcon}${req.teilprojekt}</h3>
                                <p class="text-gray-600 text-sm mt-1">${req.request_description || 'Keine Beschreibung'}</p>
                                <div class="flex items-center gap-4 mt-3">
                                    <span class="text-sm text-gray-500">
                                        <i class="fas fa-calendar mr-1"></i>
                                        Deadline: ${deadlineDate.toLocaleDateString('de-CH')}
                                    </span>
                                    <span class="px-2 py-1 rounded-full text-xs ${statusClass}">
                                        ${req.status === 'erfüllt' ? 'Erfüllt' : `${Math.abs(daysRemaining)} Tage ${daysRemaining < 0 ? 'überfällig' : 'verbleibend'}`}
                                    </span>
                                </div>
                            </div>
                            ${req.status !== 'erfüllt' ? `
                                <button onclick="createRapportForRequest('${req.id}', '${req.teilprojekt}')" 
                                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                    Rapport erstellen
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Display anforderungen for admins
        function displayAdminAnforderungen(data) {
            // Update stats - mit sicherer Prüfung
            const stats = data.stats || {
                overdue: 0,
                urgent: 0,
                pending: 0,
                fulfilled: 0
            };
            
            document.getElementById('overdue-count').textContent = stats.overdue || 0;
            document.getElementById('urgent-count').textContent = stats.urgent || 0;
            document.getElementById('pending-count').textContent = stats.pending || 0;
            document.getElementById('fulfilled-count').textContent = stats.fulfilled || 0;
            
            // Update table
            const tbody = document.getElementById('admin-anforderungen-table');
            const requests = data.requests || [];
            
            if (requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Keine Anforderungen vorhanden</td></tr>';
                return;
            }
            
            tbody.innerHTML = requests.map(req => {
                const deadlineDate = new Date(req.deadline);
                let statusBadge = '';
                
                switch(req.status) {
                    case 'überfällig':
                        statusBadge = '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs">Überfällig</span>';
                        break;
                    case 'dringend':
                        statusBadge = '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">Dringend</span>';
                        break;
                    case 'erfüllt':
                        statusBadge = '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Erfüllt</span>';
                        break;
                    default:
                        statusBadge = '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">Offen</span>';
                }
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-3 px-4">${req.requested_for_name || 'Unbekannt'}</td>
                        <td class="py-3 px-4">${req.teilprojekt}</td>
                        <td class="py-3 px-4">${deadlineDate.toLocaleDateString('de-CH')}</td>
                        <td class="py-3 px-4">${statusBadge}</td>
                        <td class="py-3 px-4">
                            <button onclick="viewRequestDetails('${req.id}')" class="text-blue-600 hover:text-blue-800 text-sm">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Show request modal for admins
        async function showRequestModal() {
            // Create modal HTML if it doesn't exist
            if (!document.getElementById('requestModal')) {
                const modalHTML = `
                    <div id="requestModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-lg bg-white">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold">Rapport anfordern</h3>
                                <button onclick="closeRequestModal()" class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <form id="requestForm" onsubmit="submitRequest(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">User auswählen</label>
                                        <select id="request-user" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                            <option value="">Bitte wählen</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Teilprojekt</label>
                                        <select id="request-teilprojekt" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                            <option value="">Bitte wählen</option>
                                            <option value="tp1-leitmedien">TP1 - Leitmedien</option>
                                            <option value="tp2-digitale-medien">TP2 - Digitale Medien</option>
                                            <option value="tp3-messen">TP3 - Messen & Ausstellungen</option>
                                            <option value="tp4-events">TP4 - Events & Aktionen</option>
                                            <option value="tp5-schulprojekte">TP5 - Schulprojekte</option>
                                            <option value="tp6-partnerprojekte">TP6 - Partnerprojekte</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Deadline</label>
                                        <input type="date" id="request-deadline" required 
                                               min="${new Date().toISOString().split('T')[0]}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Beschreibung (optional)</label>
                                        <textarea id="request-description" rows="3" 
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                                  placeholder="Zusätzliche Anweisungen oder Informationen"></textarea>
                                    </div>
                                </div>
                                <div class="flex justify-end mt-6 space-x-3">
                                    <button type="button" onclick="closeRequestModal()" 
                                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                                        Abbrechen
                                    </button>
                                    <button type="submit" 
                                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        Anforderung senden
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
            // Load users for dropdown
            await loadUsersForRequest();
            
            // Show modal
            document.getElementById('requestModal').classList.remove('hidden');
        }
        
        function closeRequestModal() {
            document.getElementById('requestModal')?.classList.add('hidden');
        }
        
        async function loadUsersForRequest() {
            try {
                console.log('Lade User-Liste für Anforderungen...');
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/users`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('User API Response:', response.status, response.ok);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('User-Daten erhalten:', data);
                    
                    const select = document.getElementById('request-user');
                    if (!select) {
                        console.error('Select element "request-user" nicht gefunden!');
                        return;
                    }
                    
                    // Prüfe ob users existiert und ist ein Array
                    const users = data.users || data;
                    if (!Array.isArray(users)) {
                        console.error('Users ist kein Array:', users);
                        return;
                    }
                    
                    const userOnly = users.filter(u => u.role === 'user');
                    console.log('Gefilterte User (nur role=user):', userOnly);
                    
                    select.innerHTML = '<option value="">Bitte wählen</option>' +
                        userOnly.map(user => 
                            `<option value="${user.id}">${user.name} (${user.email})</option>`
                        ).join('');
                } else {
                    console.error('User API Fehler:', response.status, await response.text());
                }
            } catch (error) {
                console.error('Fehler beim Laden der User:', error);
            }
        }
        
        async function submitRequest(event) {
            event.preventDefault();
            
            const requestData = {
                user_id: document.getElementById('request-user').value,
                teilprojekt: document.getElementById('request-teilprojekt').value,
                deadline: document.getElementById('request-deadline').value,
                description: document.getElementById('request-description').value
            };
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/rapporte/request`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (response.ok) {
                    showNotification('Anforderung erfolgreich gesendet', 'success');
                    closeRequestModal();
                    loadAnforderungen();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Fehler beim Senden der Anforderung', 'error');
                }
            } catch (error) {
                console.error('Fehler:', error);
                showNotification('Fehler beim Senden der Anforderung', 'error');
            }
        }
        
        function createRapportForRequest(requestId, teilprojekt) {
            // Store request ID for later use
            sessionStorage.setItem('fulfillRequestId', requestId);
            
            // Open create modal with pre-filled teilprojekt
            showCreateModal();
            
            // Pre-select teilprojekt
            setTimeout(() => {
                const select = document.getElementById('teilprojektSelect');
                if (select) {
                    select.value = teilprojekt;
                    loadTeilprojektTemplate(teilprojekt);
                }
            }, 100);
        }
        
        function viewRequestDetails(requestId) {
            // This could open a modal with more details
            console.log('View details for request:', requestId);
        }
        
        // ========== END DEADLINE FEATURE FUNCTIONS ==========
        
        // Initialize page on load
        // Setup mobile menu functionality
        function setupMobileMenu() {
            const toggle = document.getElementById('mobile-menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            
            if (toggle && sidebar && overlay) {
                toggle.addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('active');
                    document.body.classList.toggle('sidebar-open');
                });
                
                overlay.addEventListener('click', () => {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                    document.body.classList.remove('sidebar-open');
                });
                
                // Close mobile menu when clicking on a nav link
                sidebar.addEventListener('click', (e) => {
                    if (e.target.closest('.nav-link')) {
                        if (window.innerWidth < 1024) { // lg breakpoint
                            sidebar.classList.remove('active');
                            overlay.classList.remove('active');
                            document.body.classList.remove('sidebar-open');
                        }
                    }
                });
                
                // Close sidebar on resize to desktop
                window.addEventListener('resize', () => {
                    if (window.innerWidth >= 1024) {
                        sidebar.classList.remove('active');
                        overlay.classList.remove('active');
                        document.body.classList.remove('sidebar-open');
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Rapport-Seite wird initialisiert...');
            
            // Setup mobile menu
            // setupMobileMenu(); // Now handled by sidebar-component.js
            
            // Check authentication first
            await checkAuth();
            
            // Load user info for sidebar
            await loadUserInfo();
            
            // Load Templates from Database FIRST
            await loadTemplatesOnStartup();
            
            // Load rapport data
            await loadRapporte();
            
            // Load other data
            await loadTeilprojekte();
            await loadKPIDashboard();
            await loadAnforderungen(); // Load deadline requests
            
            // Set up event listeners
            const teilprojektSelect = document.getElementById('teilprojektSelect');
            if (teilprojektSelect) {
                teilprojektSelect.addEventListener('change', function() {
                    loadTeilprojektTemplate(this.value);
                });
            }
            
            console.log('Rapport-Seite vollständig geladen');
        });
    </script>
</body>
</html>