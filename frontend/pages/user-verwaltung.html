<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benutzerverwaltung - SBV Professional V2</title>
    <script src="../js/config.js"></script>
    <link rel="stylesheet" href="../assets/css/swiss-design.css">
    <style>
        /* User Management specific styles */
        .user-grid {
            display: grid;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .user-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }
        
        .user-email {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .user-meta {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }
        
        .user-role {
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .role-user {
            background: #e0f2fe;
            color: #0369a1;
        }
        
        .role-admin {
            background: #fef3c7;
            color: #d97706;
        }
        
        .role-superadmin {
            background: #fce7f3;
            color: #be185d;
        }
        
        .user-status {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .status-active {
            color: #22c55e;
        }
        
        .status-inactive {
            color: #ef4444;
        }
        
        .user-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .filter-section {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            background: var(--primary-color);
            color: white;
            padding: 1.5rem;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            opacity: 0.8;
        }

        .modal-body {
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .password-input-group {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-left">
                <img src="../assets/images/logo.png" alt="SBV Logo" class="nav-logo">
                <span class="nav-title">SBV Professional V2</span>
            </div>
            <div class="nav-right">
                <span class="nav-user" id="currentUser">L√§dt...</span>
                <button class="btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Admin Navigation -->
    <div class="admin-nav" style="background: #f8f9fa; padding: 1rem 0; margin-top: 60px;">
        <div class="container">
            <div style="display: flex; gap: 2rem; align-items: center;">
                <a href="gesuch-verwaltung.html" class="nav-link" style="color: #666;">Gesuch-Verwaltung</a>
                <a href="user-verwaltung.html" class="nav-link active" style="color: var(--primary-color); font-weight: 500;">Benutzerverwaltung</a>
                <a href="webhook-verwaltung.html" class="nav-link" style="color: #666;">Webhook-Verwaltung</a>
                <a href="rapport.html" class="nav-link" style="color: #666;">Rapporte</a>
            </div>
        </div>
    </div>

    <div class="container" style="margin-top: 20px;">
        <div class="page-header">
            <h1>Benutzerverwaltung</h1>
            <button class="btn-primary" onclick="showCreateUserModal()">
                + Neuer Benutzer
            </button>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalUsers">0</div>
                <div class="stat-label">Gesamte Benutzer</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeUsers">0</div>
                <div class="stat-label">Aktive Benutzer</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="adminUsers">0</div>
                <div class="stat-label">Administratoren</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="userRoleCount">0</div>
                <div class="stat-label">Standard-Benutzer</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filter-section">
            <h3>Filter</h3>
            <div class="filter-row">
                <div class="form-group">
                    <label>Suche</label>
                    <input type="text" id="searchFilter" class="form-control" placeholder="Name oder E-Mail..." onkeyup="filterUsers()">
                </div>
                <div class="form-group">
                    <label>Rolle</label>
                    <select id="roleFilter" class="form-control" onchange="filterUsers()">
                        <option value="">Alle Rollen</option>
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                        <option value="superadmin">Super Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="statusFilter" class="form-control" onchange="filterUsers()">
                        <option value="">Alle Status</option>
                        <option value="active">Aktiv</option>
                        <option value="inactive">Inaktiv</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- User List -->
        <div id="userList" class="user-grid">
            <!-- Users will be dynamically inserted here -->
        </div>

        <div id="noUsers" style="text-align: center; color: var(--text-secondary); padding: 3rem; display: none;">
            Keine Benutzer gefunden
        </div>
    </div>

    <!-- Create/Edit User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Neuer Benutzer</h3>
                <button class="close-btn" onclick="closeUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm" onsubmit="handleUserSubmit(event)">
                    <input type="hidden" id="userId" name="userId">
                    
                    <div class="form-group">
                        <label>Benutzername *</label>
                        <input type="text" id="username" name="username" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label>E-Mail *</label>
                        <input type="email" id="email" name="email" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Rolle *</label>
                        <select id="role" name="role" class="form-control" required>
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                            <option value="superadmin">Super Admin</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="passwordGroup">
                        <label>Passwort *</label>
                        <div class="password-input-group">
                            <input type="password" id="password" name="password" class="form-control" required>
                            <button type="button" class="toggle-password" onclick="togglePasswordVisibility()">
                                üëÅÔ∏è
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="isActive" name="isActive" checked>
                            Benutzer ist aktiv
                        </label>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="closeUserModal()">
                            Abbrechen
                        </button>
                        <button type="submit" class="btn-primary">
                            Speichern
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div id="resetPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Passwort zur√ºcksetzen</h3>
                <button class="close-btn" onclick="closeResetPasswordModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="resetPasswordForm" onsubmit="handlePasswordReset(event)">
                    <input type="hidden" id="resetUserId" name="userId">
                    
                    <p style="margin-bottom: 1rem;">
                        Neues Passwort f√ºr Benutzer: <strong id="resetUsername"></strong>
                    </p>
                    
                    <div class="form-group">
                        <label>Neues Passwort *</label>
                        <div class="password-input-group">
                            <input type="password" id="newPassword" name="newPassword" class="form-control" required minlength="6">
                            <button type="button" class="toggle-password" onclick="toggleNewPasswordVisibility()">
                                üëÅÔ∏è
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="closeResetPasswordModal()">
                            Abbrechen
                        </button>
                        <button type="submit" class="btn-primary">
                            Passwort zur√ºcksetzen
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const API_BASE_URL = window.API_BASE_URL || '';
        const token = localStorage.getItem('authToken');
        let allUsers = [];
        let currentUser = null;

        // Check authentication
        if (!token) {
            window.location.href = '/login.html';
        }

        // Initialize page
        async function initializePage() {
            try {
                // Load user info
                const userResponse = await fetch(`${API_BASE_URL}/api/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!userResponse.ok) {
                    throw new Error('Authentication failed');
                }

                const userData = await userResponse.json();
                currentUser = userData.user;
                
                // Check if user is admin
                if (userData.user.role !== 'admin' && userData.user.role !== 'superadmin') {
                    alert('Diese Seite ist nur f√ºr Administratoren zug√§nglich.');
                    window.location.href = 'rapport.html';
                    return;
                }

                document.getElementById('currentUser').textContent = userData.user.username;

                // Load users
                await loadUsers();

            } catch (error) {
                console.error('Initialization error:', error);
                if (error.message === 'Authentication failed') {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login.html';
                }
            }
        }

        // Load all users
        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/users`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load users');
                }

                const data = await response.json();
                allUsers = data.users || [];
                
                updateStatistics();
                displayUsers(allUsers);

            } catch (error) {
                console.error('Error loading users:', error);
                alert('Fehler beim Laden der Benutzer');
            }
        }

        // Update statistics
        function updateStatistics() {
            const totalUsers = allUsers.length;
            const activeUsers = allUsers.filter(u => u.is_active).length;
            const adminUsers = allUsers.filter(u => u.role === 'admin' || u.role === 'superadmin').length;
            const userRoleCount = allUsers.filter(u => u.role === 'user').length;

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('adminUsers').textContent = adminUsers;
            document.getElementById('userRoleCount').textContent = userRoleCount;
        }

        // Display users
        function displayUsers(users) {
            const container = document.getElementById('userList');
            const noUsers = document.getElementById('noUsers');
            
            if (users.length === 0) {
                container.style.display = 'none';
                noUsers.style.display = 'block';
                return;
            }
            
            container.style.display = 'grid';
            noUsers.style.display = 'none';
            
            container.innerHTML = users.map(user => `
                <div class="user-card">
                    <div class="user-info">
                        <div class="user-name">${user.username}</div>
                        <div class="user-email">${user.email}</div>
                        <div class="user-meta">
                            <span class="user-role role-${user.role}">${user.role}</span>
                            <span class="user-status ${user.is_active ? 'status-active' : 'status-inactive'}">
                                ${user.is_active ? '‚óè Aktiv' : '‚óè Inaktiv'}
                            </span>
                            <span>Erstellt: ${new Date(user.created_at).toLocaleDateString('de-CH')}</span>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn-small" onclick="editUser(${user.id})">Bearbeiten</button>
                        <button class="btn-small" onclick="resetPassword(${user.id}, '${user.username}')">Passwort</button>
                        ${user.id !== currentUser.id ? 
                            `<button class="btn-small btn-danger" onclick="deleteUser(${user.id}, '${user.username}')">L√∂schen</button>` 
                            : ''}
                    </div>
                </div>
            `).join('');
        }

        // Filter users
        function filterUsers() {
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            const filteredUsers = allUsers.filter(user => {
                const matchesSearch = !searchTerm || 
                    user.username.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm);
                
                const matchesRole = !roleFilter || user.role === roleFilter;
                
                const matchesStatus = !statusFilter || 
                    (statusFilter === 'active' && user.is_active) ||
                    (statusFilter === 'inactive' && !user.is_active);
                
                return matchesSearch && matchesRole && matchesStatus;
            });
            
            displayUsers(filteredUsers);
        }

        // Show create user modal
        function showCreateUserModal() {
            document.getElementById('modalTitle').textContent = 'Neuer Benutzer';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('passwordGroup').style.display = 'block';
            document.getElementById('password').required = true;
            document.getElementById('userModal').style.display = 'block';
        }

        // Edit user
        async function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('modalTitle').textContent = 'Benutzer bearbeiten';
            document.getElementById('userId').value = user.id;
            document.getElementById('username').value = user.username;
            document.getElementById('email').value = user.email;
            document.getElementById('role').value = user.role;
            document.getElementById('isActive').checked = user.is_active;
            document.getElementById('passwordGroup').style.display = 'none';
            document.getElementById('password').required = false;
            
            document.getElementById('userModal').style.display = 'block';
        }

        // Close user modal
        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        // Handle user form submit
        async function handleUserSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const userId = formData.get('userId');
            const isEdit = userId !== '';
            
            const userData = {
                username: formData.get('username'),
                email: formData.get('email'),
                role: formData.get('role'),
                is_active: formData.get('isActive') === 'on'
            };
            
            if (!isEdit) {
                userData.password = formData.get('password');
            }
            
            try {
                const url = isEdit ? 
                    `${API_BASE_URL}/api/users/${userId}` : 
                    `${API_BASE_URL}/api/users`;
                
                const method = isEdit ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Fehler beim Speichern');
                }

                alert(isEdit ? 'Benutzer erfolgreich aktualisiert' : 'Benutzer erfolgreich erstellt');
                closeUserModal();
                await loadUsers();

            } catch (error) {
                console.error('Error saving user:', error);
                alert(error.message);
            }
        }

        // Reset password
        function resetPassword(userId, username) {
            document.getElementById('resetUserId').value = userId;
            document.getElementById('resetUsername').textContent = username;
            document.getElementById('resetPasswordForm').reset();
            document.getElementById('resetPasswordModal').style.display = 'block';
        }

        // Close reset password modal
        function closeResetPasswordModal() {
            document.getElementById('resetPasswordModal').style.display = 'none';
        }

        // Handle password reset
        async function handlePasswordReset(event) {
            event.preventDefault();
            
            const userId = document.getElementById('resetUserId').value;
            const newPassword = document.getElementById('newPassword').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/users/${userId}/password`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password: newPassword })
                });

                if (!response.ok) {
                    throw new Error('Fehler beim Zur√ºcksetzen des Passworts');
                }

                alert('Passwort erfolgreich zur√ºckgesetzt');
                closeResetPasswordModal();

            } catch (error) {
                console.error('Error resetting password:', error);
                alert('Fehler beim Zur√ºcksetzen des Passworts');
            }
        }

        // Delete user
        async function deleteUser(userId, username) {
            if (!confirm(`M√∂chten Sie den Benutzer "${username}" wirklich l√∂schen?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Fehler beim L√∂schen');
                }

                alert('Benutzer erfolgreich gel√∂scht');
                await loadUsers();

            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Fehler beim L√∂schen des Benutzers');
            }
        }

        // Toggle password visibility
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
        }

        function toggleNewPasswordVisibility() {
            const passwordInput = document.getElementById('newPassword');
            passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
        }

        // Logout
        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = '/login.html';
        }

        // Initialize on load
        initializePage();
    </script>
</body>
</html>